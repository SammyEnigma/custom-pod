## vars ###

{% set var_main_dir = params.main.custom_dir + '/discourse' %}
{% set var_containers = params.main.containers | default([]) %}

{% set var_run = params.main.run | default({}) %}
{% set var_run_dict = params.main.run_dict | default({}) %}

{% set var_static = params.main.static | default('false') | bool %}

{% if var_static %}
  {% set var_templates_files = [
    'web.template.build.yml',
    'web.template.run.yml',
    'web.template.validate.yml'
  ] %}
{% endif %}

### main ###

{% if ((var_templates_files | default([]) | length) > 0) %}

files:

{% for item in var_templates_files %}

- src: "{{ var_main_dir }}/files/templates/{{ item }}"
  dest: "repo/templates/{{ item }}"
  root: true

{% endfor %}

{% endif %}

templates:

{% for item in var_containers %}

{% set var_docker_args = item.params.docker_args | default([]) %}
{% set ns_docker_args = namespace(list=var_docker_args) %}

{% for subitem in params.dependencies | default([]) %}
  {% set ns_docker_args.list = ns_docker_args.list + 
    ['--add-host ' + subitem.host + ':' + subitem.ip]
  %}
{% endfor %}

{% set var_params = item.params | combine({ 'docker_args': ns_docker_args.list }) %}

- src: "{{ var_main_dir }}/templates/containers/{{ item.name_src }}"
  dest: "repo/containers/{{ item.name_dest }}"
  root: true
  params: {{ var_params | to_json }}

{% endfor %}

{% if var_run | default({}) | dict2items | list | length > 0 %}

children:

- name: "main/scripts/vars.run.yml"
  params:
    env_params: {{ params | to_json }}
    pod_custom_dir: "{{ var_main_dir }}"
    run: {{ var_run | to_json }}
    run_dict: {{ var_run_dict | to_json }}

{% endif %}
