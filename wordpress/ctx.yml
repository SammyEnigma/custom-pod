## general vars - start ###

{% set var_local = params.main.local | default(false) | bool %}
{% set var_pod_type = params.main.type | default('') %}

{% if not (var_pod_type in ['app', 'web', 'db']) %}
  {% set error = {} %}
  {{ error['error.pod_type.invalid.' + var_pod_type] }}
{% endif %}

{% set var_pod_kind = 'wordpress' %}

{% set var_main_base_dir = params.main.custom_dir %}
{% set var_main_dir = var_main_base_dir + '/' + var_pod_kind %}
{% set var_main_base_dir_container = (var_local and (params.main.custom_dir_sync | default(false) | bool))
  | ternary(var_main_base_dir + '-sync', var_main_base_dir)
%}
{% set var_main_dir_container = var_main_base_dir_container + '/' + var_pod_kind %}
{% set var_shared_dir = 'shared' %}

{% set var_data_dir = params.data_dir %}

{% set var_custom_ssl_main_domain = params.main.custom_ssl.main_domain | default('') %}
{% set var_custom_ssl_fullchain = params.main.custom_ssl.fullchain | default('') %}
{% set var_custom_ssl_privkey = params.main.custom_ssl.privkey | default('') %}
{% set var_use_custom_ssl = (var_custom_ssl_main_domain != '')
  and (var_custom_ssl_fullchain != '')
  and (var_custom_ssl_privkey != '')
%}

{% set var_app_dev = var_local
  and (params.main.app_dev | default(false) | bool)
  and (var_pod_type in ['app', 'web'])
%}

{% set var_use_composer = var_app_dev
  and (params.main.use_composer | default(false) | bool)
%}

{% if var_app_dev | bool %}
  {% set var_wp_app_repo_dir_name = params.main.custom_args.wordpress.app_repo_dir %}
  {% set var_wp_app_repo_dir = params.extra_repos_dir_relpath + '/' + var_wp_app_repo_dir_name %}
{% endif %}

{% set var_main_domain_port = params.main.custom_domain.main_ssl | bool |
  ternary(params.main.custom_domain.public_https_port, params.main.custom_domain.public_http_port)
%}

{% if params.main.use_pma | bool %}
  {% set var_pma_domain_port = params.main.custom_domain.pma_ssl | bool |
    ternary(params.main.custom_domain.private_https_port, params.main.custom_domain.private_http_port)
  %}
{% endif %}

{% if params.main.use_adminer | bool %}
  {% set var_adminer_domain_port = params.main.custom_domain.adminer_ssl | bool |
    ternary(params.main.custom_domain.private_https_port, params.main.custom_domain.private_http_port)
  %}
{% endif %}

{% if params.main.use_theia | bool %}
  {% set var_theia_domain_port = params.main.custom_domain.theia_ssl | bool |
    ternary(params.main.custom_domain.private_https_port, params.main.custom_domain.private_http_port)
  %}
{% endif %}

{% if params.main.use_minio_gateway | bool %}
  {% set var_minio_gateway_domain_port = params.main.custom_domain.minio_gateway_ssl | bool |
    ternary(params.main.custom_domain.private_https_port, params.main.custom_domain.private_http_port)
  %}
{% endif %}

{% if params.main.use_filestash | bool %}
  {% set var_filestash_domain_port = params.main.custom_domain.filestash_ssl | bool |
    ternary(params.main.custom_domain.private_https_port, params.main.custom_domain.private_http_port)
  %}
{% endif %}

{% if var_pod_type in ['app', 'web'] %}
  {% set var_db_gui_user = params.main.db_gui_root_user | default(false) | bool |
    ternary('root', 'viewer')
  %}
  {% set var_db_gui_password = params.main.db_gui_root_user | default(false) | bool |
    ternary(params.credentials.mysql.root_password, params.credentials.mysql.viewer_password)
  %}
{% endif %}

### main ###

env_files:

- when: false

{% if var_pod_type in ['app', 'web'] %}

{% if var_use_custom_ssl | bool %}

- src: "{{ var_custom_ssl_fullchain }}"
  dest: "env/nginx/ssl/live/{{ var_custom_ssl_main_domain }}/fullchain.pem"

- src: "{{ var_custom_ssl_privkey }}"
  dest: "env/nginx/ssl/live/{{ var_custom_ssl_main_domain }}/privkey.pem"

{% endif %}

- src: "{{ params.main.auth_file }}"
  dest: "env/nginx/conf/.htpasswd"

{% endif %}

templates:

{% set var_ctx_full_name = params.identifier %}
{% set var_use_prefix = params.main.use_pod_prefix | default(params.main.use_pod_full_prefix | default(false, true), true) | bool %}
{% set var_pod_prefix = params.main.use_pod_full_prefix | default(false) | ternary(var_ctx_full_name, params.pod_name) %}
{% set var_ctx_prefix_main = var_use_prefix | bool | ternary(var_pod_prefix + '-main-', '') %}
{% set var_ctx_prefix_run = var_use_prefix | bool | ternary(var_pod_prefix + '-run-', '') %}

- src: "{{ var_main_dir }}/templates/docker-compose.tpl.yml"
  dest: "docker-compose.yml"
  params:
    local: "{{ var_local | default(false) }}"
    main_dir: "{{ var_main_dir_container }}"
    app_dev: "{{ var_app_dev }}"
    pod_type: "{{ var_pod_type }}"
    named_volumes: "{{ params.main.named_volumes | default(false) }}"
    use_fluentd: "{{ params.main.use_fluentd }}"
    images: {{ params.main.custom_images | to_json }}
    memory: {{ params.main.custom_memory | to_json }}

    {% if var_pod_type in ['app', 'web'] %}

    use_varnish: "{{ params.main.use_varnish }}"
    use_pma: "{{ params.main.use_pma }}"
    use_adminer: "{{ params.main.use_adminer }}"
    use_theia: "{{ params.main.use_theia }}"
    use_minio_gateway: "{{ params.main.use_minio_gateway }}"
    use_filestash: "{{ params.main.use_filestash }}"
    use_custom_ssl: "{{ var_use_custom_ssl }}"
    use_certbot: "{{ params.main.use_certbot }}"

    {% if var_local | bool %}

    use_composer: "{{ var_use_composer }}"

    {% endif %}

    {% endif %}

    {% if var_pod_type in ['app', 'cache'] %}

    use_redis: "{{ params.main.use_redis }}"
    use_memcached: "{{ params.main.use_memcached }}"

    {% endif %}

- src: "{{ var_main_dir }}/templates/docker-compose.tpl.run.yml"
  dest: "docker-compose.run.yml"
  params:
    local: "{{ var_local | default(false) }}"
    main_dir: "{{ var_main_dir_container }}"
    pod_type: "{{ var_pod_type }}"
    use_fluentd: "{{ params.main.use_fluentd }}"
    s3_cli: "{{ params.main.s3_cli }}"
    images: {{ params.main.custom_images | to_json }}
    memory: {{ params.main.custom_memory | to_json }}

    {% if var_pod_type in ['app', 'web'] %}

    use_certbot: "{{ params.main.use_certbot }}"

    {% endif %}

- src: "{{ var_main_dir }}/templates/docker-compose.env"
  dest: ".env"
  params:
    ctx_full_name: "{{ var_ctx_full_name }}"
    ctx_prefix_main: "{{ var_ctx_prefix_main }}"
    ctx_prefix_run: "{{ var_ctx_prefix_run }}"
    data_dir: "{{ var_data_dir }}"
    local: "{{ var_local | default(false) }}"
    app_dev: "{{ var_app_dev }}"
    type: "{{ var_pod_type }}"
    use_fluentd: "{{ params.main.use_fluentd }}"
    db_port: "{{ params.main.custom_args.mysql.port | default('3306', true) }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_password: "{{ params.credentials.wordpress.db.password }}"

    {% if var_pod_type in ['app', 'web'] %}

    public_http_port: "{{ params.main.custom_domain.public_http_port }}"
    public_https_port: "{{ params.main.custom_domain.public_https_port }}"
    private_http_port: "{{ params.main.custom_domain.private_http_port }}"
    private_https_port: "{{ params.main.custom_domain.private_https_port }}"
    wordpress_ini_file_type: >-
      {{
      (params.main.custom_args.wordpress.env == 'production') |
      ternary('production', 'development')
      }}
    use_certbot: "{{ params.main.use_certbot }}"
    use_minio_gateway: "{{ params.main.use_minio_gateway }}"

    {% if var_app_dev | bool %}

    wp_app_repo_dir: "{{ var_wp_app_repo_dir }}"

    {% endif %}

    {% if params.main.use_minio_gateway | bool %}

    minio_gateway_endpoint: "{{ params.credentials.minio_gateway.endpoint }}"
    minio_gateway_access_key: "{{ params.credentials.minio_gateway.access_key }}"
    minio_gateway_secret_key: "{{ params.credentials.minio_gateway.secret_key }}"

    {% endif %}

    use_pma: "{{ params.main.use_pma }}"

    {% if params.main.use_pma | bool %}

    pma_user: "{{ var_db_gui_user }}"
    pma_password: "{{ var_db_gui_password }}"
    pma_login_cookie_validity: >-
      {{ params.main.custom_args.pma.login_cookie_validity | default('36000') }}

    {% endif %}

    use_adminer: "{{ params.main.use_adminer }}"

    {% if params.main.use_adminer | bool %}

    adminer_user: "{{ var_db_gui_user }}"
    adminer_password: "{{ var_db_gui_password }}"

    {% endif %}

    {% endif %}

    {% if var_pod_type in ['app', 'db'] %}

    mysql_root_password: "{{ params.credentials.mysql.root_password }}"

    {% endif %}

    {% if var_pod_type in ['web'] %}

    {% if not var_local %}

    mysql_host_ip: ""

    {% else %}

    mysql_host_ip: "{{ params.dependencies.mysql.host }}"

    {% endif %}

    {% endif %}

    {% if params.main.use_fluentd | bool %}

    fluentd_port: "{{ params.main.custom_args.fluentd.port }}"

    {% set var_fluentd_output_plugin = params.main.custom_args.fluentd.output_plugin
      | default(
        (var_pod_type in ['app']) | ternary('file', 'elasticsearch')
      )
    %}

    fluentd_output_plugin: "{{ var_fluentd_output_plugin }}"

    {% if var_fluentd_output_plugin == 'elasticsearch' %}

    elasticsearch_host_ip: "{{ params.dependencies.elasticsearch.host }}"

    {% endif %}

    {% endif %}

{% if var_pod_type in ['app', 'web'] %}

{% if not params.main.custom_args.nginx.custom | default(false) | bool %}

- src: "{{ var_main_dir }}/templates/nginx/nginx.conf"
  dest: "env/nginx/nginx.conf"
  params:
    conf: {{ params.main.custom_args.nginx.conf | default({}) | to_json }}
    enable_validate_origin: "{{ params.main.custom_args.nginx.enable_validate_origin }}"
    main_domain: "{{ params.main.custom_domain.main_domain }}"
    main_port: "{{ var_main_domain_port }}"
    main_ssl: "{{ params.main.custom_domain.main_ssl }}"
    main: "{{ params.main.custom_args.nginx.main | default({}) }}"
    use_varnish: "{{ params.main.use_varnish }}"
    use_theia: "{{ params.main.use_theia }}"

    {% if params.main.use_theia | bool %}

    theia_domain: "{{ params.main.custom_domain.theia_domain }}"
    theia_port: "{{ var_theia_domain_port }}"
    theia_ssl: "{{ params.main.custom_domain.theia_ssl }}"

    {% endif %}

    use_minio_gateway: "{{ params.main.use_minio_gateway }}"

    {% if params.main.use_minio_gateway | bool %}

    minio_gateway_domain: "{{ params.main.custom_domain.minio_gateway_domain }}"
    minio_gateway_port: "{{ var_minio_gateway_domain_port }}"
    minio_gateway_ssl: "{{ params.main.custom_domain.minio_gateway_ssl }}"

    {% endif %}

    use_filestash: "{{ params.main.use_filestash }}"

    {% if params.main.use_filestash | bool %}

    filestash_domain: "{{ params.main.custom_domain.filestash_domain }}"
    filestash_port: "{{ var_filestash_domain_port }}"
    filestash_ssl: "{{ params.main.custom_domain.filestash_ssl }}"

    {% endif %}

    use_pma: "{{ params.main.use_pma }}"

    {% if params.main.use_pma | bool %}

    pma_domain: "{{ params.main.custom_domain.pma_domain }}"
    pma_port: "{{ var_pma_domain_port }}"
    pma_ssl: "{{ params.main.custom_domain.pma_ssl }}"

    {% endif %}

    use_adminer: "{{ params.main.use_adminer }}"

    {% if params.main.use_adminer | bool %}

    adminer_domain: "{{ params.main.custom_domain.adminer_domain }}"
    adminer_port: "{{ var_adminer_domain_port }}"
    adminer_ssl: "{{ params.main.custom_domain.adminer_ssl }}"

    {% endif %}

{% endif %}

{% if params.main.use_varnish | bool %}

- src: "{{ var_main_dir }}/templates/varnish/default.vcl"
  dest: "env/varnish/default.vcl"
  params: {}

{% endif %}

{% set var_main_domain = params.main.custom_domain.main_domain %}
{% set var_main_external_port = var_main_domain_port %}
{% set var_main_external_host = (params.main.custom_domain.main_ssl | bool | ternary('https', 'http'))
  + '://' + var_main_domain
  + (((var_main_external_port | string) in ['80', '443'])
  | ternary('', ':' + (var_main_external_port | string)))
%}

- src: "{{ var_main_dir }}/templates/wordpress/wp.env"
  dest: "env/wordpress/.env"
  params:
    env: "{{ params.main.custom_args.wordpress.env }}"
    db_host: "mysql"
    db_port: "{{ params.main.custom_args.mysql.port }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_password: "{{ params.credentials.wordpress.db.password }}"
    home: "{{ var_main_external_host }}"
    auth_key: "{{ params.credentials.wordpress.config.auth_key }}"
    secure_auth_key: "{{ params.credentials.wordpress.config.secure_auth_key }}"
    logged_in_key: "{{ params.credentials.wordpress.config.logged_in_key }}"
    nonce_key: "{{ params.credentials.wordpress.config.nonce_key }}"
    auth_salt: "{{ params.credentials.wordpress.config.auth_salt }}"
    secure_auth_salt: "{{ params.credentials.wordpress.config.secure_auth_salt }}"
    logged_in_salt: "{{ params.credentials.wordpress.config.logged_in_salt }}"
    nonce_salt: "{{ params.credentials.wordpress.config.nonce_salt }}"
    table_prefix: "{{ params.main.custom_args.wordpress.table_prefix | default('wp_') }}"
    wplang: "{{ params.main.custom_args.wordpress.lang }}"
    debug: "{{ params.main.custom_args.wordpress.debug | default(false) | lower }}"
    use_w3tc: "{{ params.main.use_w3tc | default(true) }}"
    use_s3_uploads: "{{ params.main.use_s3_storage }}"

    {% if params.main.use_s3_storage | bool %}

    s3_uploads_bucket: >-
      {{ params.main.uploads_bucket_name }}{{
        ((params.main.uploads_bucket_path | default('')) != '')
        | ternary('/' + params.main.uploads_bucket_path, '')
      }}"
    s3_uploads_region: "{{ params.credentials.uploads_bucket.region | default('') }}"
    s3_uploads_key: "{{ params.credentials.uploads_bucket.access_key }}"
    s3_uploads_secret: "{{ params.credentials.uploads_bucket.secret_key }}"
    s3_uploads_bucket_url: "{{ params.main.uploads_bucket_name_cdn_url | default('') }}"
    s3_uploads_endpoint: "{{ params.credentials.uploads_bucket.endpoint }}"
    s3_use_path_style_endpoint: "{{ params.credentials.uploads_bucket.path_style | default(false) }}"
    s3_provider: "{{ params.credentials.uploads_bucket.provider | default('') }}"

    {% endif %}

{% endif %}

{% if var_pod_type in ['app', 'db'] %}

- src: "{{ var_shared_dir }}/templates/mysql/init.sql"
  dest: "env/mysql/init.sql"
  params:
    viewer_password: "{{ params.credentials.mysql.viewer_password }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_password: "{{ params.credentials.wordpress.db.password }}"

{% endif %}

{% if params.main.s3_cli == 'awscli' %}
  {% set var_s3_config_src = var_shared_dir + '/templates/awscli/credentials.ini' %}
  {% set var_s3_config_dest = 'env/awscli/credentials.ini' %}
{% elif params.main.s3_cli == 'rclone' %}
  {% set var_s3_config_src = var_shared_dir + '/templates/rclone/rclone.conf' %}
  {% set var_s3_config_dest = 'env/rclone/rclone.conf' %}
{% elif params.main.s3_cli == 'mc' %}
  {% set var_s3_config_src = var_shared_dir + '/templates/mc/config.json.j2' %}
  {% set var_s3_config_dest = 'env/mc/config.json' %}
{% endif %}

- src: "{{ var_s3_config_src }}"
  dest: "{{ var_s3_config_dest }}"
  params:
    - alias: "backup"
      endpoint: "{{ params.credentials.backup_bucket.endpoint }}"
      region: "{{ params.credentials.backup_bucket.region | default('') }}"
      access_key: "{{ params.credentials.backup_bucket.access_key }}"
      secret_key: "{{ params.credentials.backup_bucket.secret_key }}"
    - alias: "uploads"
      endpoint: "{{ params.credentials.uploads_bucket.endpoint }}"
      region: "{{ params.credentials.uploads_bucket.region | default('') }}"
      access_key: "{{ params.credentials.uploads_bucket.access_key }}"
      secret_key: "{{ params.credentials.uploads_bucket.secret_key }}"
      when: "{{ var_pod_type in ['app', 'web'] }}"
    - alias: "backup_replica"
      endpoint: "{{ params.credentials.backup_replica_bucket.endpoint }}"
      region: "{{ params.credentials.backup_replica_bucket.region | default('') }}"
      access_key: "{{ params.credentials.backup_replica_bucket.access_key }}"
      secret_key: "{{ params.credentials.backup_replica_bucket.secret_key }}"
      when: "{{ (params.main.enable_backup_replica | bool) and (var_pod_type in ['app', 'web']) }}"
    - alias: "uploads_replica"
      endpoint: "{{ params.credentials.uploads_replica_bucket.endpoint }}"
      region: "{{ params.credentials.uploads_replica_bucket.region | default('') }}"
      access_key: "{{ params.credentials.uploads_replica_bucket.access_key }}"
      secret_key: "{{ params.credentials.uploads_replica_bucket.secret_key }}"
      when: "{{ (params.main.enable_uploads_replica | bool) and (var_pod_type in ['app', 'web']) }}"

- src: "main/vars/vars.tpl.sh"
  dest: "vars.sh"
  mode: '{{ var_local | ternary(0666, 0640) }}'
  params:
    var_ctx_full_name: "{{ var_ctx_full_name }}"

    {% if var_local | bool %}

    var_data_dir_rel: "{{ params.data_dir }}"

    {% else %}

    var_data_dir: "{{ params.data_dir }}"

    {% endif %}

    var_shared__script_dir: "{{ var_shared_dir }}/scripts"
    var_shared__delete_old__days: "3"
    var_custom__pod_type: "{{ var_pod_type }}"
    var_custom__local: "{{ var_local | bool | ternary('true', 'false') }}"
    var_custom__app_dev: "{{ var_app_dev | bool | ternary('true', 'false') }}"
    var_custom__use_main_network: "true"
    var_custom__use_s3_storage: "{{ params.main.use_s3_storage | default(false) | bool | ternary('true', 'false') }}"
    var_custom__use_logrotator: "true"
    var_custom__use_nginx: "true"
    var_custom__use_mysql: "true"
    var_custom__use_fluentd: "{{ params.main.use_fluentd | bool | ternary('true', 'false') }}"

    {% if var_pod_type in ['app', 'web'] %}

    {% if params.main.enable_backup_replica | bool %}

    var_shared__s3_replicate_backup__bucket_dest_name: "{{ params.main.backup_replica_bucket_name }}"
    var_shared__s3_replicate_backup__bucket_dest_path: "{{ params.main.backup_replica_bucket_path | default('') }}"

    {% endif %}

    {% if params.main.enable_uploads_replica | bool %}

    var_shared__s3_replicate_uploads__bucket_dest_name: "{{ params.main.uploads_replica_bucket_name }}"
    var_shared__s3_replicate_uploads__bucket_dest_path: "{{ params.main.uploads_replica_bucket_path | default('') }}"

    {% endif %}

    var_custom__use_theia: "{{ params.main.use_theia | bool | ternary('true', 'false') }}"
    var_custom__use_varnish: "{{ params.main.use_varnish | bool | ternary('true', 'false') }}"
    var_custom__use_custom_ssl: "{{ var_use_custom_ssl | bool | ternary('true', 'false') }}"
    var_custom__use_certbot: "{{ params.main.use_certbot | bool | ternary('true', 'false') }}"

    var_custom__block_ips: "{{ params.main.block_ips | bool | ternary('true', 'false') }}"

    {% if params.main.block_ips | bool %}

    var_shared__block_ips__action_exec__max_amount: "{{ params.main.block_ips.max_amount | default('10000') }}"
    var_shared__block_ips__action_exec__amount_day: "{{ params.main.block_ips.amount_day | default('20000') }}"
    var_shared__block_ips__action_exec__amount_hour: "{{ params.main.block_ips.amount_hour | default('3600') }}"

    {% endif %}

    var_custom__use_composer: "{{ var_use_composer | bool | ternary('true', 'false') }}"
    var_run__migrate__wp_activate_all_plugins: >-
      "{{ params.main.migrate_wp_activate_all_plugins | default(false) | bool | ternary('true', 'false') }}"
    var_run__migrate__wp_plugins_to_activate: "{{ params.main.migrate_wp_plugins_to_activate }}"
    var_run__migrate__wp_plugins_to_deactivate: "{{ params.main.migrate_wp_plugins_to_deactivate }}"

    {% endif %}

    {% if var_app_dev | bool %}

    var_dev__repo_dir_wordpress: "{{ var_wp_app_repo_dir }}"

    {% endif %}

    {% if not (params.main.log_summary.disabled | default(false) | bool) %}

    var_custom__log_summary__days_ago: "{{ params.main.log_summary.days_ago | default('1') }}"
    var_custom__log_summary__max_amount: "{{ params.main.log_summary.max_amount | default('100') }}"
    var_custom__log_summary__verify_size_docker_dir: >-
      {{ params.main.log_summary.verify_size_docker_dir | default(false) | bool | ternary('true', 'false') }}
    var_custom__log_summary__verify_size_containers: >-
      {{ params.main.log_summary.verify_size_containers | default(true) | bool | ternary('true', 'false') }}

    {% endif %}

    # General

    var_run__general__backup_is_delete_old: "true"
    var_run__general__main_base_dir: "{{ var_main_base_dir }}"
    var_run__general__main_base_dir_container: "{{ var_main_base_dir_container }}"
    var_run__general__orchestration: "compose"
    var_run__general__script_dir: "{{ var_main_dir }}/scripts"
    var_run__general__script_env_file: "{{ var_local | bool | ternary('local.sh', 'remote.sh') }}"
    var_run__general__toolbox_service: "toolbox"
    var_run__migrate__new_domain_host: "{{ params.main.migrate_new_domain_host | default('') }}"
    var_run__migrate__old_domain_host: "{{ params.main.migrate_old_domain_host | default('') }}"
    var_run__migrate__wp_rewrite_structure: >-
      {{ params.main.migrate_wp_rewrite_structure | default('') }}
    var_run__migrate__use_w3tc: >-
      {{ params.main.use_w3tc | default(true) | bool | ternary('true', 'false') }}
    var_run__migrate__use_varnish: >-
      {{ params.main.use_varnish | default(false) | bool | ternary('true', 'false') }}
    var_run__migrate__use_redis: >-
      {{ params.main.use_redis | default(false) | bool | ternary('true', 'false') }}
    var_run__migrate__use_memcached: >-
      {{ params.main.use_memcached | default(false) | bool | ternary('true', 'false') }}
    var_run__tasks__backup: "group_backup"
    var_run__tasks__setup: "group_setup"

    # Tasks (Group)

    {% set var_group_backup = [] %}

    {% if var_pod_type in ['app', 'db'] %}

      {% if params.main.enable_db_backup | bool %}

        {% set var_group_backup = var_group_backup + ['db_backup'] %}

      {% endif %}

    {% endif %}

    {% if (var_pod_type in ['app', 'web']) and (not (params.main.use_s3_storage | bool)) %}

      {% if params.main.enable_uploads_backup | bool %}

        {% set var_group_backup = var_group_backup + ['uploads_backup'] %}

      {% endif %}

    {% endif %}

    var_task__group_backup__group_task__task_names: "{{ var_group_backup | join(',') }}"
    var_task__group_backup__task__type: "group"

    {% set var_group_setup = [] %}

    {% if params.main.restore_db | bool %}

      {% if (var_pod_type in ['app', 'web']) and (not (params.main.use_s3_storage | bool)) %}

        {% if params.main.enable_uploads_setup | bool %}

          {% set var_group_setup = var_group_setup + ['uploads_setup'] %}

        {% endif %}

      {% endif %}

      {% if var_pod_type in ['app', 'db'] %}

        {% if params.main.enable_db_setup | bool %}

          {% set var_group_setup = var_group_setup + ['db_setup'] %}

        {% endif %}

      {% endif %}

    {% else %}

      {% if var_pod_type in ['app', 'web'] %}

        {% if params.main.enable_db_setup_new | bool %}

          {% set var_group_setup = var_group_setup + ['db_setup_new'] %}

        {% endif %}

      {% endif %}

    {% endif %}

    var_task__group_setup__group_task__task_names: "{{ var_group_setup | join(',') }}"
    var_task__group_setup__task__type: "group"

    # Tasks (Specific)

    {% if var_pod_type in ['app', 'web'] %}

    {% if params.main.use_certbot | bool %}

    var_task__certbot__certbot_subtask__certbot_service: "certbot"
    var_task__certbot__certbot_subtask__data_base_path: "/var/main/data/sync/certbot"
    var_task__certbot__certbot_subtask__dev: "{{ params.main.certbot.dev | default(var_local) | bool | ternary('true', 'false') }}"
    var_task__certbot__certbot_subtask__domains: "{{ params.main.certbot.domains }}"
    var_task__certbot__certbot_subtask__email: "{{ params.main.certbot.email }}"
    var_task__certbot__certbot_subtask__force: "{{ params.main.certbot.force | bool | ternary('true', 'false') }}"
    var_task__certbot__certbot_subtask__main_domain: "{{ params.main.certbot.main_domain }}"
    var_task__certbot__certbot_subtask__rsa_key_size: "{{ params.main.certbot.rsa_key_size | default('4096') }}"
    var_task__certbot__certbot_subtask__staging: "{{ params.main.certbot.staging | default(var_local) | bool | ternary('true', 'false') }}"
    var_task__certbot__certbot_subtask__toolbox_service: "toolbox"
    var_task__certbot__certbot_subtask__webservice_type: "nginx"
    var_task__certbot__certbot_task__certbot_cmd: "setup"
    var_task__certbot__task__type: "certbot"

    {% endif %}

    {% endif %}

    {% if var_pod_type in ['app', 'db'] %}

    {% if params.main.enable_db_backup | bool %}

    {% set var_db_file_name = params.main.db_backup.db_file_name
      | default(params.credentials.wordpress.db.name + '.sql')
    %}
    {% set var_db_compressed_file_name = params.main.db_backup.db_compressed_file_name
      | default(params.credentials.wordpress.db.name + '.[[ datetime ]].[[ random ]].zip')
    %}
    {% set var_db_src_dir = '/tmp/main/tmp/mysql/backup' %}
    {% set var_db_tmp_dir = '/tmp/main/tmp/backup/mysql' %}
    {% set var_db_compress_type = params.main.db_backup.db_compress_type | default('zip') %}
    {% set var_db_compress_src_file = var_db_src_dir + '/' + var_db_file_name %}
    {% set var_db_compress_dest_file = var_db_tmp_dir + '/' + var_db_compressed_file_name %}
    {% set var_db_subtask_cmd_local = 'backup:local:db' %}
    {% set var_db_subtask_cmd_db = 'db:backup:file:mysql' %}
    {% set var_db_subtask_cmd_remote = 'backup:remote:default' %}
    {% set var_db_subtask_cmd_s3 = 's3:subtask:s3_backup' %}

    var_task__db_backup__task__type: "backup"
    var_task__db_backup__backup_task__subtask_cmd_local: "{{ var_db_subtask_cmd_local }}"
    var_task__db_backup__backup_task__subtask_cmd_remote: "{{ var_db_subtask_cmd_remote }}"
    var_task__db_backup__backup_task__is_compressed_file: >-
      {{ params.main.db_backup.is_compressed_file | default(false) | bool | ternary('true', 'false') }}

    {% if params.main.db_backup.is_compressed_file | default(false) | bool %}

    var_task__db_backup__backup_task__recursive_dir: "{{ var_db_src_dir }}"
    var_task__db_backup__backup_task__compress_type: "{{ var_db_compress_type }}"
    var_task__db_backup__backup_task__compress_src_file: >-
      {{ params.main.db_backup.compress_src_file | default(var_db_compress_src_file) }}
    var_task__db_backup__backup_task__compress_src_dir: >-
      {{ params.main.db_backup.compress_src_dir | default('') }}
    var_task__db_backup__backup_task__compress_dest_file: "{{ var_db_compress_dest_file }}"
    var_task__db_backup__backup_task__compress_pass: >-
      {{ params.credentials.wp_db.compress_pass | default('') }}

    {% else %}

    var_task__db_backup__backup_task__recursive_dir: "{{ var_db_tmp_dir }}"

    {% endif %}

    var_task__db_backup__backup_task__backup_date_format: "{{ params.main.db_backup.backup_date_format | default('') }}"
    var_task__db_backup__backup_task__backup_time_format: "{{ params.main.db_backup.backup_time_format | default('') }}"
    var_task__db_backup__backup_task__backup_datetime_format: "{{ params.main.db_backup.backup_datetime_format | default('') }}"
    var_task__db_backup__backup_task__recursive_mode: "{{ params.main.db_backup.recursive_mode | default('') }}"
    var_task__db_backup__backup_task__recursive_mode_dir: "{{ params.main.db_backup.recursive_mode_dir | default('') }}"
    var_task__db_backup__backup_task__recursive_mode_file: "{{ params.main.db_backup.recursive_mode_file | default('') }}"
    var_task__db_backup__backup_task__file_to_clear: "{{ params.main.db_backup.file_to_clear | default('') }}"
    var_task__db_backup__backup_task__dir_to_clear: "{{ params.main.db_backup.dir_to_clear | default('') }}"
    var_task__db_backup__backup_local__db_file_name: "{{ var_db_file_name }}"
    var_task__db_backup__backup_local__db_task_base_dir: "{{ var_db_src_dir }}"
    var_task__db_backup__backup_local__db_subtask_cmd: "{{ var_db_subtask_cmd_db }}"
    var_task__db_backup__backup_local__task_name: "db_main"
    var_task__db_backup__backup_remote__backup_bucket_sync_dir: >-
      {{ params.main.db_backup.backup_bucket_sync_dir | default('[[ date ]]') }}
    var_task__db_backup__backup_remote__backup_date_format: "{{ params.main.db_backup.backup_date_format | default('') }}"
    var_task__db_backup__backup_remote__backup_time_format: "{{ params.main.db_backup.backup_time_format | default('') }}"
    var_task__db_backup__backup_remote__backup_datetime_format: "{{ params.main.db_backup.backup_datetime_format | default('') }}"
    var_task__db_backup__backup_remote__subtask_cmd_s3: "{{ var_db_subtask_cmd_s3 }}"

    {% if params.main.db_backup.is_compressed_file | default(false) | bool %}

    var_task__db_backup__backup_remote__backup_src_file: "{{ var_db_compress_dest_file }}"

    {% else %}

    var_task__db_backup__backup_remote__backup_src_dir: "{{ var_db_src_dir }}"

    {% endif %}

    {% endif %}

    {% endif %}

    var_task__db_main__db_subtask__db_connect_wait_secs: "{{ params.main.db_main.db_connect_wait_secs | default('300') }}"
    var_task__db_main__db_subtask__db_name: "{{ params.credentials.wordpress.db.name }}"
    var_task__db_main__db_subtask__db_pass: "{{ params.credentials.wordpress.db.password }}"
    var_task__db_main__db_subtask__db_service: "mysql"
    var_task__db_main__db_subtask__db_user: "{{ params.credentials.wordpress.db.user }}"

    {% if var_pod_type in ['app', 'db'] %}

    {% if (params.main.restore_db | bool) and (params.main.enable_db_setup | bool) %}

    {% set var_db_dest_dir = '/tmp/main/tmp/mysql/restore' %}
    {% set var_verify_file_to_skip = params.main.db_setup.verify_file_to_skip | default('/tmp/main/setup/db.skip') %}
    {% set var_db_compress_type = params.main.db_setup.db_compress_type | default('zip') %}
    {% set var_db_compress_file_name = params.main.db_setup.db_compress_file_name
      | default(params.credentials.wordpress.db.name + '.zip')
    %}
    {% set var_db_compress_file = '/tmp/main/tmp/restore/mysql/' + var_db_compress_file_name %}
    {% set var_db_file_name = params.main.db_setup.db_file_name
      | default(params.credentials.wordpress.db.name + '.sql')
    %}
    {% set var_db_subtask_cmd_verify = 'setup:verify:db' %}
    {% set var_db_subtask_cmd_remote = 'setup:remote:default' %}
    {% set var_db_subtask_cmd_local = 'setup:local:db' %}
    {% set var_db_verify_cmd = 'db:restore:verify:mysql' %}
    {% set var_db_local_cmd = 'db:restore:file:mysql' %}

    var_task__db_setup__task__type: "setup"
    var_task__db_setup__setup_task__verify_file_to_skip: "{{ var_verify_file_to_skip }}"
    var_task__db_setup__setup_task__subtask_cmd_verify: "{{ var_db_subtask_cmd_verify }}"
    var_task__db_setup__setup_task__subtask_cmd_remote: "{{ var_db_subtask_cmd_remote }}"
    var_task__db_setup__setup_task__subtask_cmd_local: "{{ var_db_subtask_cmd_local }}"
    var_task__db_setup__setup_task__is_compressed_file: >-
      {{ params.main.db_setup.is_compressed_file | default(false) | bool | ternary('true', 'false') }}

    {% if params.main.db_setup.is_compressed_file | default(false) | bool %}

    var_task__db_setup__setup_task__compress_type: "{{ var_db_compress_type }}"
    var_task__db_setup__setup_task__compress_src_file: "{{ var_db_compress_file }}"
    var_task__db_setup__setup_task__compress_dest_dir: "{{ var_db_dest_dir }}"
    var_task__db_setup__setup_task__compress_pass: "{{ params.credentials.wp_db.compress_pass | default('') }}"

    {% endif %}

    var_task__db_setup__setup_task__recursive_dir: "{{ var_db_dest_dir }}"
    var_task__db_setup__setup_task__recursive_mode: "{{ params.main.db_setup.recursive_mode | default('') }}"
    var_task__db_setup__setup_task__recursive_mode_dir: >-
      {{ params.main.db_setup.recursive_mode_dir | default('777') }}
    var_task__db_setup__setup_task__recursive_mode_file: >-
      {{ params.main.db_setup.recursive_mode_file | default('666') }}
    var_task__db_setup__setup_task__file_to_clear: >-
      {{ params.main.db_setup.file_to_clear | default(var_db_compress_file) }}
    var_task__db_setup__setup_task__dir_to_clear: "{{ var_db_dest_dir }}"
    var_task__db_setup__setup_verify__db_subtask_cmd: "{{ var_db_verify_cmd }}"
    var_task__db_setup__setup_verify__task_name: "db_main"
    var_task__db_setup__setup_remote__restore_use_s3: >-
      {{ params.main.db_setup.restore_use_s3 | bool | ternary('true', 'false') }}

    {% if not (params.main.db_setup.restore_use_s3 | bool) %}

    var_task__db_setup__setup_remote__restore_dest_file: "{{ var_db_compress_file }}"
    var_task__db_setup__setup_remote__restore_remote_file: "{{ params.main.db_setup.restore_remote_file }}"

    {% else %}

    var_task__db_setup__setup_remote__subtask_cmd_s3: "s3:subtask:s3_backup"
    var_task__db_setup__setup_remote__restore_s3_sync: >-
      {{ params.main.db_setup.restore_s3_sync | bool | ternary('true', 'false') }}

    {% if params.main.db_setup.restore_s3_sync | bool %}

    var_task__db_setup__setup_remote__restore_dest_dir: "{{ var_db_dest_dir }}"
    var_task__db_setup__setup_remote__restore_bucket_path_dir: >-
      {{ params.main.db_setup.restore_bucket_path_dir | default('') }}

    {% else %}

    var_task__db_setup__setup_remote__restore_dest_file: "{{ var_db_compress_file_name }}"
    var_task__db_setup__setup_remote__restore_bucket_path_file: >-
      {{ params.main.db_setup.restore_bucket_path_file | default('') }}

    {% endif %}

    {% endif %}

    var_task__db_setup__setup_local__db_file_name: "{{ var_db_file_name }}"
    var_task__db_setup__setup_local__db_subtask_cmd: "{{ var_db_local_cmd }}"
    var_task__db_setup__setup_local__db_task_base_dir: "{{ var_db_dest_dir }}"
    var_task__db_setup__setup_local__task_name: "db_main"

    {% endif %}

    {% endif %}

    {% if var_pod_type in ['app', 'web'] %}

    {% if (not (params.main.restore_db | bool)) and (params.main.enable_db_setup_new | bool) %}

    {% set var_verify_file_to_skip = params.main.db_setup.verify_file_to_skip | default('/tmp/main/setup/db.skip') %}

    var_task__db_setup_new__setup_new__admin_email: "{{ params.credentials.wordpress.setup.admin_email }}"
    var_task__db_setup_new__setup_new__admin_password: "{{ params.credentials.wordpress.setup.admin_password }}"
    var_task__db_setup_new__setup_new__admin_user: "{{ params.credentials.wordpress.setup.admin_user }}"
    var_task__db_setup_new__setup_new__remote_seed_data: "{{ params.main.db_setup_new.remote_seed_data }}"
    var_task__db_setup_new__setup_new__restore_seed: "{{ params.main.db_setup_new.restore_seed }}"
    var_task__db_setup_new__setup_new__title: "{{ params.main.db_setup_new.title }}"
    var_task__db_setup_new__setup_new__url: "{{ params.main.db_setup_new.url }}"
    var_task__db_setup_new__setup_task__setup_run_new_task: "true"
    var_task__db_setup_new__setup_task__subtask_cmd_new: "setup:new"
    var_task__db_setup_new__setup_task__verify_file_to_skip: "{{ var_verify_file_to_skip }}"
    var_task__db_setup_new__setup_task__subtask_cmd_verify: "setup:verify:db"
    var_task__db_setup_new__setup_verify__db_subtask_cmd: "db:restore:verify:mysql"
    var_task__db_setup_new__setup_verify__task_name: "db_main"
    var_task__db_setup_new__task__type: "setup"

    {% endif %}

    {% endif %}

    {% if params.main.enable_logs_backup | bool %}

    var_task__logs_backup__task__type: "backup"
    var_task__logs_backup__backup_task__subtask_cmd_remote: "backup:remote:default"
    var_task__logs_backup__backup_remote__backup_bucket_sync_dir: "log/{{ var_pod_type }}"
    var_task__logs_backup__backup_remote__backup_src_dir: "/var/log/main"
    var_task__logs_backup__backup_remote__subtask_cmd_s3: "s3:subtask:s3_backup"

    {% endif %}

    {% if params.main.enable_logs_setup | bool %}

    {% set var_dest_dir = '/var/log/main' %}
    {% set var_verify_file_to_skip = params.main.logs_setup.verify_file_to_skip | default('/tmp/main/setup/logs.skip') %}

    var_task__logs_setup__task__type: "setup"
    var_task__logs_setup__setup_task__verify_file_to_skip: "{{ var_verify_file_to_skip }}"
    var_task__logs_setup__setup_task__subtask_cmd_remote: "setup:remote:default"
    var_task__logs_setup__setup_task__recursive_dir: "{{ var_dest_dir }}"
    var_task__logs_setup__setup_task__recursive_mode: "{{ params.main.logs_setup.recursive_mode | default('') }}"
    var_task__logs_setup__setup_task__recursive_mode_dir: >-
      {{ params.main.logs_setup.recursive_mode_dir | default('777') }}
    var_task__logs_setup__setup_task__recursive_mode_file: >-
      {{ params.main.logs_setup.recursive_mode_file | default('666') }}
    var_task__logs_setup__setup_verify__setup_dest_dir_to_verify: "{{ var_dest_dir }}"
    var_task__logs_setup__setup_remote__restore_use_s3: "true"
    var_task__logs_setup__setup_remote__subtask_cmd_s3: "s3:subtask:s3_backup"
    var_task__logs_setup__setup_remote__restore_s3_sync: "true"
    var_task__logs_setup__setup_remote__restore_dest_dir: "{{ var_dest_dir }}"
    var_task__logs_setup__setup_remote__restore_bucket_path_dir: >-
      {{ params.main.logs_setup.restore_bucket_path_dir | default('') }}

    {% endif %}

    var_task__s3_backup__s3_subtask__bucket_name: "{{ params.main.backup_bucket_name }}"
    var_task__s3_backup__s3_subtask__bucket_path: "{{ params.main.backup_bucket_path | default('') }}"
    var_task__s3_backup__s3_subtask__cli: "{{ params.main.s3_cli }}"
    var_task__s3_backup__s3_subtask__cli_cmd: "run"
    var_task__s3_backup__s3_subtask__tmp_dir: "/tmp/main/tmp/s3_backup"
    var_task__s3_backup__s3_subtask__endpoint: "{{ params.credentials.backup_bucket.endpoint }}"
    var_task__s3_backup__s3_subtask__service: "s3_cli"

    {% if var_pod_type in ['app', 'web'] %}

    {% if params.main.enable_backup_replica | bool %}

    var_task__s3_backup_replica__s3_subtask__bucket_name: "{{ params.main.backup_bucket_name }}"
    var_task__s3_backup_replica__s3_subtask__bucket_path: "{{ params.main.backup_bucket_path | default('') }}"
    var_task__s3_backup_replica__s3_subtask__cli: "{{ params.main.s3_cli }}"
    var_task__s3_backup_replica__s3_subtask__cli_cmd: "run"
    var_task__s3_backup_replica__s3_subtask__tmp_dir: "/tmp/main/tmp/s3_backup_replica"
    var_task__s3_backup_replica__s3_subtask__endpoint: "{{ params.credentials.backup_bucket.endpoint }}"
    var_task__s3_backup_replica__s3_subtask__service: "s3_cli"

    {% endif %}

    {% if params.main.enable_uploads_replica | bool %}

    var_task__s3_uploads_replica__s3_subtask__bucket_name: "{{ params.main.uploads_bucket_name }}"
    var_task__s3_uploads_replica__s3_subtask__bucket_path: "{{ params.main.uploads_bucket_path | default('') }}"
    var_task__s3_uploads_replica__s3_subtask__cli: "{{ params.main.s3_cli }}"
    var_task__s3_uploads_replica__s3_subtask__cli_cmd: "run"
    var_task__s3_uploads_replica__s3_subtask__tmp_dir: "/tmp/main/tmp/s3_uploads_replica"
    var_task__s3_uploads_replica__s3_subtask__endpoint: "{{ params.credentials.uploads_bucket.endpoint }}"
    var_task__s3_uploads_replica__s3_subtask__service: "s3_cli"

    {% endif %}

    var_task__s3_uploads__s3_subtask__bucket_name: "{{ params.main.uploads_bucket_name }}"
    var_task__s3_uploads__s3_subtask__bucket_path: "{{ params.main.uploads_bucket_path | default('') }}"
    var_task__s3_uploads__s3_subtask__cli: "{{ params.main.s3_cli }}"
    var_task__s3_uploads__s3_subtask__cli_cmd: "run"
    var_task__s3_uploads__s3_subtask__tmp_dir: "/tmp/main/tmp/s3_uploads"
    var_task__s3_uploads__s3_subtask__endpoint: "{{ params.credentials.uploads_bucket.endpoint }}"
    var_task__s3_uploads__s3_subtask__service: "s3_cli"

    {% endif %}

    {% if params.main.enable_sync_backup | bool %}

    var_task__sync_backup__task__type: "backup"
    var_task__sync_backup__backup_task__subtask_cmd_remote: "backup:remote:default"
    var_task__sync_backup__backup_remote__backup_bucket_sync_dir: "sync"
    var_task__sync_backup__backup_remote__backup_src_dir: "/var/sync/main"
    var_task__sync_backup__backup_remote__subtask_cmd_s3: "s3:subtask:s3_backup"

    {% endif %}

    {% if params.main.enable_sync_setup | bool %}

    {% set var_dest_dir = '/var/sync/main' %}
    {% set var_verify_file_to_skip = params.main.sync_setup.verify_file_to_skip | default('/tmp/main/setup/sync.skip') %}

    var_task__sync_setup__task__type: "setup"
    var_task__sync_setup__setup_task__verify_file_to_skip: "{{ var_verify_file_to_skip }}"
    var_task__sync_setup__setup_task__subtask_cmd_remote: "setup:remote:default"
    var_task__sync_setup__setup_task__recursive_dir: "{{ var_dest_dir }}"
    var_task__sync_setup__setup_task__recursive_mode: "{{ params.main.sync_setup.recursive_mode | default('') }}"
    var_task__sync_setup__setup_task__recursive_mode_dir: >-
      {{ params.main.sync_setup.recursive_mode_dir | default('777') }}
    var_task__sync_setup__setup_task__recursive_mode_file: >-
      {{ params.main.sync_setup.recursive_mode_file | default('666') }}
    var_task__sync_setup__setup_verify__setup_dest_dir_to_verify: "{{ var_dest_dir }}"
    var_task__sync_setup__setup_remote__restore_use_s3: "true"
    var_task__sync_setup__setup_remote__subtask_cmd_s3: "s3:subtask:s3_backup"
    var_task__sync_setup__setup_remote__restore_s3_sync: "true"
    var_task__sync_setup__setup_remote__restore_dest_dir: "{{ var_dest_dir }}"
    var_task__sync_setup__setup_remote__restore_bucket_path_dir: >-
      {{ params.main.sync_setup.restore_bucket_path_dir | default('') }}

    {% endif %}

    {% if (var_pod_type in ['app', 'web']) and (not (params.main.use_s3_storage | bool)) %}

    {% if params.main.enable_uploads_backup | bool %}

    {% set var_uploads_src_dir = '/var/main/data/wordpress/uploads' %}
    {% set var_uploads_tmp_dir = '/tmp/main/tmp/backup/uploads' %}
    {% set var_uploads_compress_type = params.main.uploads_backup.compress_type | default('zip') %}
    {% set var_uploads_compressed_file_name = params.main.uploads_backup.compressed_file_name
      | default('uploads.[[ datetime ]].[[ random ]].zip')
    %}
    {% set var_uploads_compress_dest_file = var_uploads_tmp_dir + '/' + var_uploads_compressed_file_name %}
    {% set var_uploads_subtask_cmd_remote = 'backup:remote:default' %}
    {% set var_uploads_subtask_cmd_s3 = 's3:subtask:s3_uploads' %}

    var_task__uploads_backup__task__type: "backup"
    var_task__uploads_backup__backup_task__subtask_cmd_remote: "{{ var_uploads_subtask_cmd_remote }}"
    var_task__uploads_backup__backup_task__is_compressed_file: >-
      {{ params.main.uploads_backup.is_compressed_file | default(false) | bool | ternary('true', 'false') }}

    {% if params.main.uploads_backup.is_compressed_file | default(false) | bool %}

    var_task__uploads_backup__backup_task__compress_type: "{{ var_uploads_compress_type }}"
    var_task__uploads_backup__backup_task__compress_src_dir: "{{ var_uploads_src_dir }}"
    var_task__uploads_backup__backup_task__compress_dest_file: "{{ var_uploads_compress_dest_file }}"
    var_task__uploads_backup__backup_task__compress_pass: >-
      {{ params.credentials.wp_uploads.compress_pass | default('') }}

    {% endif %}

    var_task__uploads_backup__backup_task__backup_date_format: "{{ params.main.uploads_backup.backup_date_format | default('') }}"
    var_task__uploads_backup__backup_task__backup_time_format: "{{ params.main.uploads_backup.backup_time_format | default('') }}"
    var_task__uploads_backup__backup_task__backup_datetime_format: "{{ params.main.uploads_backup.backup_datetime_format | default('') }}"
    var_task__uploads_backup__backup_task__recursive_dir: "{{ var_uploads_tmp_dir }}"
    var_task__uploads_backup__backup_task__recursive_mode: "{{ params.main.uploads_backup.recursive_mode | default('') }}"
    var_task__uploads_backup__backup_task__recursive_mode_dir: "{{ params.main.uploads_backup.recursive_mode_dir | default('') }}"
    var_task__uploads_backup__backup_task__recursive_mode_file: "{{ params.main.uploads_backup.recursive_mode_file | default('') }}"
    var_task__uploads_backup__backup_task__file_to_clear: "{{ params.main.uploads_backup.file_to_clear | default('') }}"
    var_task__uploads_backup__backup_task__dir_to_clear: "{{ params.main.uploads_backup.dir_to_clear | default('') }}"
    var_task__uploads_backup__backup_remote__backup_bucket_sync_dir:  >-
      {{ params.main.uploads_backup.backup_bucket_sync_dir | default('[[ date ]]') }}
    var_task__uploads_backup__backup_remote__subtask_cmd_s3: "{{ var_uploads_subtask_cmd_s3 }}"
    var_task__uploads_backup__backup_remote__backup_date_format: "{{ params.main.uploads_backup.backup_date_format | default('') }}"
    var_task__uploads_backup__backup_remote__backup_time_format: "{{ params.main.uploads_backup.backup_time_format | default('') }}"
    var_task__uploads_backup__backup_remote__backup_datetime_format: "{{ params.main.uploads_backup.backup_datetime_format | default('') }}"

    {% if params.main.uploads_backup.is_compressed_file | default(false) | bool %}

    var_task__uploads_backup__backup_remote__backup_src_file: "{{ var_uploads_compress_dest_file }}"

    {% else %}

    var_task__uploads_backup__backup_remote__backup_src_dir: "{{ var_uploads_src_dir }}"

    {% endif %}

    {% endif %}

    {% if (params.main.restore_db | bool) and (params.main.enable_uploads_setup | bool) %}

    {% set var_uploads_s3_sync = (params.main.uploads_setup.restore_use_s3 | bool)
      and (params.main.uploads_setup.restore_s3_sync | bool)
    %}
    {% set var_uploads_dest_dir = '/var/main/data/wordpress/uploads' %}
    {% set var_verify_file_to_skip = params.main.uploads_setup.verify_file_to_skip | default('/tmp/main/setup/uploads.skip') %}
    {% set var_uploads_tmp_base_dir = '/tmp/main/tmp/wordpress' %}
    {% set var_uploads_compress_type = params.main.uploads_setup.compress_type | default('zip') %}
    {% set var_uploads_compressed_file_name = params.main.uploads_setup.compressed_file_name | default('uploads.zip') %}
    {% set var_uploads_compress_file = '/tmp/main/tmp/restore/uploads/' + var_uploads_compressed_file_name %}

    var_task__uploads_setup__task__type: "setup"
    var_task__uploads_setup__setup_task__verify_file_to_skip: "{{ var_verify_file_to_skip }}"
    var_task__uploads_setup__setup_task__subtask_cmd_remote: "setup:remote:default"
    var_task__uploads_setup__setup_task__is_compressed_file: >-
      {{ params.main.uploads_setup.is_compressed_file | default(false) | bool | ternary('true', 'false') }}

    {% if params.main.uploads_setup.is_compressed_file | default(false) | bool %}

    var_task__uploads_setup__setup_task__compress_type: "{{ var_uploads_compress_type }}"
    var_task__uploads_setup__setup_task__compress_src_file: "{{ var_uploads_compress_file }}"
    var_task__uploads_setup__setup_task__compress_dest_dir: "{{ var_uploads_tmp_base_dir }}"
    var_task__uploads_setup__setup_task__compress_pass: >-
      {{ params.credentials.wp_uploads.compress_pass | default('') }}

    {% endif %}

    var_task__uploads_setup__setup_task__recursive_mode: "{{ params.main.uploads_setup.recursive_mode | default('') }}"
    var_task__uploads_setup__setup_task__recursive_mode_dir: "{{ params.main.uploads_setup.recursive_mode_dir | default('777') }}"
    var_task__uploads_setup__setup_task__recursive_mode_file: "{{ params.main.uploads_setup.recursive_mode_file | default('666') }}"

    {% if not var_uploads_s3_sync | bool %}

    {% set var_uploads_tmp_dir = var_uploads_tmp_base_dir + '/'
      + params.main.uploads_setup.restore_compressed_inner_dir
    %}

    var_task__uploads_setup__setup_task__recursive_dir: "{{ var_uploads_tmp_dir }}"
    var_task__uploads_setup__setup_task__move_src: "{{ var_uploads_tmp_dir }}"
    var_task__uploads_setup__setup_task__move_dest: "{{ var_uploads_dest_dir }}"
    var_task__uploads_setup__setup_task__file_to_clear: ""
    var_task__uploads_setup__setup_task__dir_to_clear: "{{ var_uploads_tmp_dir }}"

    {% else %}

    var_task__uploads_setup__setup_task__recursive_dir: "{{ var_uploads_dest_dir }}"

    {% endif %}

    var_task__uploads_setup__setup_verify__setup_dest_dir_to_verify: "{{ var_uploads_dest_dir }}"
    var_task__uploads_setup__setup_remote__restore_use_s3: >-
      {{ params.main.uploads_setup.restore_use_s3 | bool | ternary('true', 'false') }}

    {% if not (params.main.uploads_setup.restore_use_s3 | bool) %}

    var_task__uploads_setup__setup_remote__restore_dest_file: >-
      {{ params.main.uploads_setup.restore_dest_file | default(var_uploads_compress_file) }}
    var_task__uploads_setup__setup_remote__restore_remote_file: >-
      {{ params.main.uploads_setup.restore_remote_file }}

    {% else %}

    var_task__uploads_setup__setup_remote__subtask_cmd_s3: "s3:subtask:s3_uploads"
    var_task__uploads_setup__setup_remote__restore_s3_sync: >-
      {{ params.main.uploads_setup.restore_s3_sync | bool | ternary('true', 'false') }}
    var_task__uploads_setup__setup_remote__restore_dest_dir: >-
      {{ params.main.uploads_setup.restore_dest_dir | default(var_uploads_dest_dir) }}
    var_task__uploads_setup__setup_remote__restore_dest_file: >-
      {{ params.main.uploads_setup.restore_dest_file | default('') }}
    var_task__uploads_setup__setup_remote__restore_bucket_path_dir: >-
      {{ params.main.uploads_setup.restore_bucket_path_dir | default('') }}
    var_task__uploads_setup__setup_remote__restore_bucket_path_file: >-
      {{ params.main.uploads_setup.restore_bucket_path_file | default('') }}

    {% endif %}

    {% endif %}

    {% endif %}