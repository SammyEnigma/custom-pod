## general vars - start ###

{% set var_local = params.main.local | default(false) | bool %}
{% set var_run = params.main.run | default({}) %}
{% set var_run_dict = params.main.run_dict | default({}) %}

{% set var_containers_dict = params.main.containers_dict | default({}) %}

## general vars - end ###

{% set var_wp_pod_type = params.main.type %}

# {% set var_wp_domain = params.main.custom.wordpress.domain %}
# {% set var_wp_ssl = params.main.custom.wordpress.ssl | default(false) %}
# {% set var_wp_port = params.main.custom.wordpress.port 
#   | default(var_wp_ssl | bool | ternary('443', '80')) 
# %}
# {% set var_wp_external_ssl = params.main.custom.nginx.wordpress.ssl | default(var_wp_ssl) %}
# {% set var_wp_external_port = params.main.custom.nginx.wordpress.external_port | default(var_wp_port) %}
# {% set var_wp_external_host = (var_wp_external_ssl | bool | ternary('https', 'http')) 
#   + '://' + var_wp_domain 
#   + ((var_wp_external_port in ['80', '443']) | ternary('', ':' + var_wp_external_port)) 
# %}

### others ###

{% set var_main_dir = params.main.custom_dir + '/wordpress' %}
{% set var_apps_dir_base = params.dirs.apps_dir_base %}
{% set var_app_repo_dir = var_apps_dir_base + '/' + 
  (params.pod.app.wp_local.dir_rel | default('')) 
%}
{% set var_wp_app_name = params.main.custom.wordpress.app_name | default('') %}
{% set var_dev_repo_dir_wordpress = var_local 
  | ternary(params.pod.app[var_wp_app_name].dir_rel | default(''), '') 
%}

### main ###

templates:

- src: "{{ var_main_dir }}/templates/docker-compose.env"
  dest: "{{ var_main_dir }}/.env"
  root: true
  params: 
    ctx_name: "{{ params.main.env_name }}-{{ params.main.ctx_name }}-{{ params.pod.name }}"
    data_dir: "{{ params.pod.data_dir }}"
    local: "{{ var_local | default(false) | bool | ternary('true', 'false') }}"
    db_host: "{{ params.main.custom.mysql.host }}"
    db_port: "{{ params.main.custom.mysql.port }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_password: "{{ params.credentials.wordpress.db.password }}"
    mysql_root_password: "{{ params.credentials.mysql.root_password }}"
    wp_app_repo_dir: "{{ var_local | default(false) | bool | ternary(var_app_repo_dir, '') }}"

- src: "{{ var_main_dir }}/templates/wp.env"
  dest: "{{ var_main_dir }}/env/wordpress/.env"
  root: true
  params: 
    env: "{{ item_params.env }}"
    db_host: "{{ params.main.custom.mysql.host }}"
    db_port: "{{ params.main.custom.mysql.port }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_password: "{{ params.credentials.wordpress.db.password }}"
    home: "{{ item_params.external_host }}"
    siteurl: "{{ item_params.external_host }}"
    auth_key: "{{ params.credentials.wordpress.config.auth_key }}"
    secure_auth_key: "{{ params.credentials.wordpress.config.secure_auth_key }}"
    logged_in_key: "{{ params.credentials.wordpress.config.logged_in_key }}"
    nonce_key: "{{ params.credentials.wordpress.config.nonce_key }}"
    auth_salt: "{{ params.credentials.wordpress.config.auth_salt }}"
    secure_auth_salt: "{{ params.credentials.wordpress.config.secure_auth_salt }}"
    logged_in_salt: "{{ params.credentials.wordpress.config.logged_in_salt }}"
    nonce_salt: "{{ params.credentials.wordpress.config.nonce_salt }}"
    table_prefix: "{{ params.main.custom.wordpress.table_prefix | default('wp_') }}"
    wplang: "{{ params.main.custom.wordpress.lang }}"
    wp_debug: "{{ params.main.custom.wordpress.debug | default(false) | lower }}"

children:

- name: "main/vars/vars.run.yml"
  params:
    env_params: {{ params | to_json }}
    run: {{ var_run | to_json }}
    run_dict: {{ var_run_dict | to_json }}
    run_custom:
      var_wp_pod_type: "{{ var_wp_pod_type }}"
      var_dev_repo_dir_wordpress: >-
        {{ var_local | ternary(params.pod.app[var_wp_app_name].dir_rel | default(''), '') }}
