## general vars - start ###

{% set var_local = params.main.local | default(false) | bool %}
{% set var_run = params.main.run | default({}) %}
{% set var_run_dict = params.main.run_dict | default({}) %}

## general vars - end ###

### others ###

{% set var_wp_pod_type = params.main.type | default('') %}

{% if not (var_wp_pod_type in ['app', 'web', 'db']) %}
  {% set error = {} %}
  {{ error['error.pod_type.invalid.' + var_wp_pod_type] }}
{% endif %}

{% set var_main_dir = params.main.custom_dir + '/wordpress' %}

{% set var_pod_dir_rel = '../..' %}
{% set var_data_dir = var_local 
  | ternary(var_pod_dir_rel + '/' + params.pod.data_dir, params.pod.data_dir) %}
{% set var_data_dir_task = params.pod.local_data_dir_inside 
  | default(params.pod.data_dir, true) 
%}

{% set var_orchestration_main_file = 'docker-compose.' + var_wp_pod_type +
  (var_local | ternary('.dev.yml', '.yml')) 
%}
{% set var_orchestration_run_file = 'docker-compose.run.yml' %}

### main ###

volumes:

- when: false

{% if var_wp_pod_type in ['app', 'db'] %}

- path: "{{ var_data_dir_task + '/mysql' }}"
  mode: "0755"

{% endif %}

{% if var_wp_pod_type in ['app', 'web'] %}

- path: "{{ var_data_dir_task + '/wordpress/uploads' }}"
  mode: "0777"

{% endif %}

templates:

- src: "{{ var_main_dir }}/templates/docker-compose.env"
  dest: "{{ var_main_dir }}/.env"
  root: true
  params: 
    ctx_name: "{{ params.env_name }}-{{ params.ctx_name }}-{{ params.pod.name }}"
    data_dir: "{{ var_data_dir }}"
    local: "{{ var_local | default(false) | bool | ternary('true', 'false') }}"
    type: "{{ var_wp_pod_type }}"
    toolbox_image: "{{ params.main.custom_images.toolbox_image }}"
    toolbox_version: "{{ params.main.custom_images.toolbox_version }}"
    awscli_image: "{{ params.main.custom_images.awscli_image }}"
    awscli_version: "{{ params.main.custom_images.awscli_version }}"
    db_host: "{{ params.main.custom_args.mysql.host }}"
    db_port: "{{ params.main.custom_args.mysql.port }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_password: "{{ params.credentials.wordpress.db.password }}"
    container_mem_toolbox: "{{ params.main.custom_memory.toolbox }}"

    {% if var_wp_pod_type in ['app', 'web'] %}

    {% set var_apps_dir_base = params.dirs.apps_dir_base %}
    {% set var_app_repo_dir = var_pod_dir_rel + '/' + var_apps_dir_base + '/' + 
      (params.pod.app.wp_local.dir_rel | default('')) 
    %}
    
    nginx_image: "{{ params.main.custom_images.nginx_image }}"
    nginx_version: "{{ params.main.custom_images.nginx_version }}"
    wordpress_image: "{{ params.main.custom_images.wordpress_image }}"
    wordpress_version: "{{ params.main.custom_images.wordpress_version }}"
    pma_image: "{{ params.main.custom_images.pma_image }}"
    pma_version: "{{ params.main.custom_images.pma_version }}"
    composer_image: "{{ params.main.custom_images.composer_image }}"
    composer_version: "{{ params.main.custom_images.composer_version }}"
    main_domain: "{{ params.main.custom_domain.main_domain }}"
    main_domain_port: "{{ params.main.custom_domain.main_port }}"
    pma_domain: "{{ params.main.custom_domain.pma_domain }}"
    pma_domain_port: "{{ params.main.custom_domain.pma_port }}"
    pma_login_cookie_validity: >-
      {{ params.main.custom_args.wordpress.pma.login_cookie_validity | default('36000') }}
    s3_uploads_access_key: "{{ params.credentials.wp_uploads_bucket.access_key }}"
    s3_uploads_secret_key: "{{ params.credentials.wp_uploads_bucket.secret_key }}"
    wordpress_env: "{{ params.main.custom_args.wordpress.env }}"
    wp_app_repo_dir: "{{ var_local | default(false) | bool | ternary(var_app_repo_dir, '') }}"
    container_mem_nginx: "{{ params.main.custom_memory.nginx }}"
    container_mem_wordpress: "{{ params.main.custom_memory.wordpress }}"
    container_mem_pma: "{{ params.main.custom_memory.pma }}"
    container_mem_composer: "{{ params.main.custom_memory.composer }}"
    container_mem_s3_uploads: "{{ params.main.custom_memory.s3_uploads }}"

    {% endif %}

    {% if var_wp_pod_type in ['app', 'db'] %}

    mysql_image: "{{ params.main.custom_images.mysql_image }}"
    mysql_version: "{{ params.main.custom_images.mysql_version }}"
    mysql_root_password: "{{ params.credentials.mysql.root_password }}"
    s3_db_access_key: "{{ params.credentials.wp_db_bucket.access_key }}"
    s3_db_secret_key: "{{ params.credentials.wp_db_bucket.secret_key }}"
    container_mem_mysql: "{{ params.main.custom_memory.mysql }}"
    container_mem_s3_db: "{{ params.main.custom_memory.s3_db }}"

    {% endif %}

{% if var_wp_pod_type in ['app', 'web'] %}

{% set var_wp_domain = params.main.custom_domain.main_domain %}
{% set var_wp_external_port = params.main.custom_domain.main_port %}
{% set var_wp_external_host = (params.main.custom_domain.main_ssl | bool | ternary('https', 'http')) 
  + '://' + var_wp_domain
  + (((var_wp_external_port | string) in ['80', '443']) 
  | ternary('', ':' + (var_wp_external_port | string))) 
%}

- src: "{{ var_main_dir }}/templates/wp.env"
  dest: "{{ var_main_dir }}/env/wordpress/.env"
  root: true
  params: 
    env: "{{ params.main.custom_args.wordpress.env }}"
    db_host: "{{ params.main.custom_args.mysql.host }}"
    db_port: "{{ params.main.custom_args.mysql.port }}"
    db_name: "{{ params.credentials.wordpress.db.name }}"
    db_user: "{{ params.credentials.wordpress.db.user }}"
    db_password: "{{ params.credentials.wordpress.db.password }}"
    home: "{{ var_wp_external_host }}"
    auth_key: "{{ params.credentials.wordpress.config.auth_key }}"
    secure_auth_key: "{{ params.credentials.wordpress.config.secure_auth_key }}"
    logged_in_key: "{{ params.credentials.wordpress.config.logged_in_key }}"
    nonce_key: "{{ params.credentials.wordpress.config.nonce_key }}"
    auth_salt: "{{ params.credentials.wordpress.config.auth_salt }}"
    secure_auth_salt: "{{ params.credentials.wordpress.config.secure_auth_salt }}"
    logged_in_salt: "{{ params.credentials.wordpress.config.logged_in_salt }}"
    nonce_salt: "{{ params.credentials.wordpress.config.nonce_salt }}"
    table_prefix: "{{ params.main.custom_args.wordpress.table_prefix | default('wp_') }}"
    wplang: "{{ params.main.custom_args.wordpress.lang }}"
    wp_debug: "{{ params.main.custom_args.wordpress.debug | default(false) | lower }}"

{% endif %}

children:

- name: "main/vars/vars.run.yml"
  params:
    env_params: {{ params | to_json }}
    pod_custom_dir: "{{ var_main_dir }}"
    run: {{ var_run | to_json }}
    run_dict: {{ var_run_dict | to_json }}
    run_custom:
      var_wp_pod_type: "{{ var_wp_pod_type }}"
      var_orchestration_main_file: "{{ var_orchestration_main_file }}"
      var_orchestration_run_file: "{{ var_orchestration_run_file }}"

      {% if var_local and (var_wp_pod_type in ['app', 'web']) %}

      {% set var_wp_app_name = params.main.custom_args.wordpress.app_name | default('') %}
      {% set var_dev_repo_dir_wordpress = params.pod.app[var_wp_app_name].dir_rel | default('') %}

      var_dev_repo_dir_wordpress: "{{ var_dev_repo_dir_wordpress }}"

      {% endif %}
