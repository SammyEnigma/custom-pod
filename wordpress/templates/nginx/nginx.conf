worker_processes {{ params.conf.worker_process | default('1', true) }};

events {
  worker_connections {{ params.conf.worker_connections | default('512', true) }};
}

http {
  {% macro include_ssl() %}

    ssl_certificate       /etc/ssl/live/{{ params.main_domain }}/fullchain.pem;
    ssl_certificate_key   /etc/ssl/live/{{ params.main_domain }}/privkey.pem;
    include               include/options-ssl-nginx.conf;
    ssl_dhparam           include/ssl-dhparams.pem;

  {% endmacro %}

  {% macro include_server_info(
    arg_domain,
    arg_listen,
    arg_port,
    arg_ssl,
    arg_private,
    arg_use_basic_auth,
    arg_validate_origin)
  %}

    server_name {{ arg_domain }};
    listen {{ arg_listen }};
		server_tokens off;

    {% if arg_use_basic_auth | bool %}

    auth_basic           "Administratorâ€™s Area";
    auth_basic_user_file conf/.htpasswd;

    {% endif %}

    {% if not (arg_private | bool) %}

    if ( $ip_blacklist = 1 ) {
        return 403;
    }
    if ( $ua_blacklist = 1 ) {
        return 403;
    }

    {% endif %}

    {% if (params.enable_validate_origin | bool) and (arg_validate_origin | bool) %}

    {% set var_port_suffix = (arg_port in ('80', '443')) | ternary('', ':' + arg_port) %}

    set $my_origin "{{ arg_ssl | bool | ternary('https', 'http') }}://{{ arg_domain }}{{ var_port_suffix }}";
    include               include/validate-origin.conf;

    {% endif %}

    {% if arg_ssl | bool %}

    {{ include_ssl() }}

    {% endif %}

    {% if (arg_listen | string) == '80' %}

		location /.well-known/acme-challenge/ {
			root /var/www/certbot;
		}

    {% endif %}

  {% endmacro %}

  {% macro include_redirect(arg_domain, arg_port, arg_ssl) %}

    {% set var_protocol = arg_ssl | bool | ternary('https', 'http') %}
    {% set var_port_suffix = (arg_port in ('80', '443')) | ternary('', ':' + arg_port) %}

		location / {
      return 301 {{ var_protocol }}://{{ arg_domain }}{{ var_port_suffix }}$request_uri;
		}

  {% endmacro %}

  {% macro include_location_info(arg_service, arg_port, arg_use_basic_auth, arg_upgrade) %}

      {% set var_port_suffix = (arg_port in ('80', '443')) | ternary('', ':' + arg_port) %}

      resolver {{ params.conf.resolver | default('127.0.0.11', true) }} valid={{ params.conf.resolver_time | default('30s', true) }};

      set $var_proxy     {{ arg_service }};
      proxy_pass         $var_proxy;
      proxy_redirect     off;
      proxy_set_header   Host                $host{{ var_port_suffix }};
      proxy_set_header   X-Real-IP           $remote_addr;
      proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Host    $server_name;
      proxy_set_header   X-Forwarded-Proto   $scheme;
      proxy_set_header   X-Forwarded-Port    {{ arg_port }};

      {% if arg_upgrade | bool %}

      proxy_set_header   Upgrade             $http_upgrade;
      proxy_set_header   Connection          $connection_upgrade;

      {% endif %}

      {% if arg_use_basic_auth | bool %}

      proxy_set_header   Authorization       "";

      {% endif %}

  {% endmacro %}

  {% macro include_default(
    arg_service,
    arg_domain,
    arg_port,
    arg_listen,
    arg_ssl,
    arg_upgrade,
    arg_private,
    arg_use_basic_auth,
    arg_main_domain)
  %}

  {% set var_http_port = arg_private | bool | ternary('9080', '80') %}

  {% if ((arg_main_domain == '') or (arg_domain != arg_main_domain)) and (arg_private | bool) %}

  server {
    {{ include_server_info(arg_domain, 80, arg_port, false, arg_private, false, false) }}
  }

  {% endif %}

  {% if arg_ssl | bool %}

  server {
    {{ include_server_info(arg_domain, var_http_port, arg_port, false, arg_private, false, false) }}
    {{ include_redirect(arg_domain, arg_port, arg_ssl) }}
  }

  {% endif %}

  server {
    {{ include_server_info(arg_domain, arg_listen, arg_port, arg_ssl, arg_private, arg_use_basic_auth, true) }}

    location / {
      {{ include_location_info(arg_service, arg_port, arg_use_basic_auth, arg_upgrade) }}
    }
  }

  {% endmacro %}

  {% set var_default_log_format = '$remote_addr $sent_http_x_user_id $upstream_response_time $status $remote_user [$time_local] "$host" "$request" $body_bytes_sent "$http_referer" "$http_user_agent" $request_time' %}

  log_format main '{{ params.conf.log_format | default(var_default_log_format, true) }}';
  access_log /dev/stdout main;
  error_log /dev/stderr;

  limit_req_zone $binary_remote_addr zone=mainlimit:10m rate={{ params.conf.limit_req_zone_rate | default('3r/s', true) }};
  limit_conn_zone $binary_remote_addr zone=connlimit:10m;
  limit_conn_zone $binary_remote_addr zone=uploadconnlimit:10m;

  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=web_cache:{{ params.conf.web_cache | default('20m', true) }} max_size={{ params.conf.web_cache_max_size | default('200m', true) }} inactive={{ params.conf.web_cache_inactive | default('30m', true) }};
  proxy_connect_timeout  {{ params.conf.proxy_connect_timeout | default('30', true) }};
  proxy_send_timeout     {{ params.conf.proxy_send_timeout | default('60', true) }};
  proxy_read_timeout     {{ params.conf.proxy_read_timeout | default('60', true) }};

  send_timeout           {{ params.conf.send_timeout | default('60', true) }};
  client_body_timeout    {{ params.conf.client_body_timeout | default('5s', true) }};
  client_header_timeout  {{ params.conf.client_header_timeout | default('5s', true) }};

	include include/gzip.conf;

	map_hash_max_size {{ params.conf.map_hash_max_size | default('1024', true) }};
	map_hash_bucket_size {{ params.conf.map_hash_bucket_size | default('128', true) }};

	geo $ip_blacklist {
		include /var/main/data/sync/nginx/manual/ips-blacklist.conf;
		include /var/main/data/sync/nginx/auto/ips-blacklist-auto.conf;
		default 0;
	}

	map $http_user_agent $ua_blacklist {
		include /var/main/data/sync/nginx/manual/ua-blacklist.conf;
		default 0;
	}

  map $http_upgrade $connection_upgrade {
      default upgrade;
      '' close;
  }

  server {
    listen 80 default_server;
    listen 8080 default_server;
    listen 9080 default_server;
    return 444;
  }

  {% if params.main_ssl | bool %}

  server {
    listen 443 default_server ssl;
    listen 8443 default_server ssl;
    listen 9443 default_server ssl;

    {{ include_ssl() }}

    return 444;
  }

  {% endif %}

  {% set var_main_service = params.use_varnish | bool | ternary('http://varnish:80', 'http://wordpress:80') %}
  {% set var_main_listen = params.main_ssl | bool | ternary('443 ssl', '80') %}
  {% set var_main_private = false %}
  {% set var_main_use_basic_auth = false %}
  {% set var_main_validate_origin = false %}

  {% macro include_main_server_info(arg_domain, arg_listen, arg_ssl, arg_use_basic_auth) %}

    {{ include_server_info(
      arg_domain,
      arg_listen,
      params.main_port,
      arg_ssl,
      var_main_private,
      arg_use_basic_auth,
      var_main_validate_origin)
    }}

  {% endmacro %}

  {% macro include_main_location_info() %}

      {{ include_location_info(var_main_service, params.main_port, var_main_use_basic_auth, true) }}

  {% endmacro %}

  {% if params.main_ssl | bool %}

  server {
    {{ include_main_server_info('www.' + params.main_domain, 80, false, false) }}
    {{ include_redirect(params.main_domain, params.main_port, params.main_ssl) }}
  }

  server {
    {{ include_main_server_info(params.main_domain, 80, false, false) }}
    {{ include_redirect(params.main_domain, params.main_port, params.main_ssl) }}
  }

  {% endif %}

  server {
    {{ include_main_server_info('www.' + params.main_domain, var_main_listen, params.main_ssl, false) }}
    {{ include_redirect(params.main_domain, params.main_port, params.main_ssl) }}
  }

  server {
    {{ include_main_server_info(params.main_domain, var_main_listen, params.main_ssl, var_main_use_basic_auth) }}

    location /wp-admin/ {
      proxy_read_timeout         {{ params.main.admin.proxy_read_timeout | default('240', true) }};
      client_max_body_size       {{ params.main.admin.client_max_body_size | default('10M', true) }};

      limit_req zone=mainlimit burst={{ params.main.admin.limit_req_burst | default('6', true) }} nodelay;
      limit_conn uploadconnlimit {{ params.main.admin.uploadconnlimit | default('5', true) }};

      {{ include_main_location_info() }}
    }

    location / {
      {{ include_main_location_info() }}
    }
  }

  {% set var_private_port = params.main_ssl | bool | ternary('9443', '9080') %}
  {% set var_private_listen = params.main_ssl | bool | ternary('9443 ssl', '9080') %}
  {% set var_private_private = true %}
  {% set var_private_use_basic_auth = true %}
  {% set var_private_validate_origin = false %}

  {% macro include_private_server_info(arg_listen, arg_ssl, arg_use_basic_auth) %}

    {{ include_server_info(
      params.main_domain,
      arg_listen,
      var_private_port,
      arg_ssl,
      var_private_private,
      arg_use_basic_auth,
      var_private_validate_origin)
    }}

  {% endmacro %}

  {% macro include_private_location_info() %}

		location = /nginx/basic_status {
			stub_status;
		}

    location / {
      return 404;
    }

  {% endmacro %}

  {% if params.main_ssl | bool %}

  server {
    {{ include_private_server_info('9080', false, false) }}
    {{ include_redirect(params.main_domain, '9443', params.main_ssl) }}
  }

  {% endif %}

  server {
    {{ include_private_server_info('9081', false, false) }}
    {{ include_private_location_info() }}
  }

  server {
    {{ include_private_server_info(var_private_listen, params.main_ssl, var_private_use_basic_auth) }}
    {{ include_private_location_info() }}
  }

  {% if params.use_theia | bool %}

  {% set var_theia_service = 'http://theia:3000' %}
  {% set var_theia_listen = params.theia_ssl | bool | ternary('9443 ssl', '9080') %}
  {% set var_theia_upgrade = true %}
  {% set var_theia_private = true %}
  {% set var_theia_use_basic_auth = true %}

  {{ include_default(
    var_theia_service,
    params.theia_domain,
    params.theia_port,
    var_theia_listen,
    params.theia_ssl,
    var_theia_upgrade,
    var_theia_private,
    var_theia_use_basic_auth,
    params.main_domain)
  }}

  {% endif %}

  {% if params.use_minio_gateway | bool %}

  {% set var_minio_gateway_service = 'http://minio_gateway:9000' %}
  {% set var_minio_gateway_listen = params.minio_gateway_ssl | bool | ternary('9443 ssl', '9080') %}
  {% set var_minio_gateway_upgrade = false %}
  {% set var_minio_gateway_private = true %}
  {% set var_minio_gateway_use_basic_auth = false %}

  {{ include_default(
    var_minio_gateway_service,
    params.minio_gateway_domain,
    params.minio_gateway_port,
    var_minio_gateway_listen,
    params.minio_gateway_ssl,
    var_minio_gateway_upgrade,
    var_minio_gateway_private,
    var_minio_gateway_use_basic_auth,
    params.main_domain)
  }}

  {% endif %}

  {% if params.use_filestash | bool %}

  {% set var_filestash_service = 'http://filestash:8334' %}
  {% set var_filestash_listen = params.filestash_ssl | bool | ternary('9443 ssl', '9080') %}
  {% set var_filestash_upgrade = true %}
  {% set var_filestash_private = true %}
  {% set var_filestash_use_basic_auth = true %}

  {{ include_default(
    var_filestash_service,
    params.filestash_domain,
    params.filestash_port,
    var_filestash_listen,
    params.filestash_ssl,
    var_filestash_upgrade,
    var_filestash_private,
    var_filestash_use_basic_auth,
    params.main_domain)
  }}

  {% endif %}

  {% if params.use_pma | bool %}

  {% set var_pma_service = 'http://phpmyadmin:80' %}
  {% set var_pma_listen = params.pma_ssl | bool | ternary('9443 ssl', '9080') %}
  {% set var_pma_upgrade = false %}
  {% set var_pma_private = true %}
  {% set var_pma_use_basic_auth = true %}

  {{ include_default(
    var_pma_service,
    params.pma_domain,
    params.pma_port,
    var_pma_listen,
    params.pma_ssl,
    var_pma_upgrade,
    var_pma_private,
    var_pma_use_basic_auth,
    params.main_domain)
  }}

  {% endif %}

  {% if params.use_adminer | bool %}

  {% set var_adminer_service = 'http://adminer:8080' %}
  {% set var_adminer_listen = params.adminer_ssl | bool | ternary('9443 ssl', '9080') %}
  {% set var_adminer_upgrade = false %}
  {% set var_adminer_private = true %}
  {% set var_adminer_use_basic_auth = true %}

  {{ include_default(
    var_adminer_service,
    params.adminer_domain,
    params.adminer_port,
    var_adminer_listen,
    params.adminer_ssl,
    var_adminer_upgrade,
    var_adminer_private,
    var_adminer_use_basic_auth,
    params.main_domain)
  }}

  {% endif %}
}