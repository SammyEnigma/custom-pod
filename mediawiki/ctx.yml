## general vars - start ###

{% set var_local = params.main.local | default(false) | bool %}
{% set var_run = params.main.run | default({}) %}
{% set var_run_dict = params.main.run_dict | default({}) %}

## general vars - end ###

### others ###

{% set var_pod_type = params.main.type | default('') %}

{% if not (var_pod_type in ['app']) %}
  {% set error = {} %}
  {{ error['error.pod_type.invalid.' + var_pod_type] }}
{% endif %}

{% set var_main_dir = params.main.custom_dir + '/mediawiki' %}

{% set var_pod_dir_rel = '../..' %}
{% set var_data_dir = var_local
  | ternary(var_pod_dir_rel + '/' + params.pod.data_dir, params.pod.data_dir) %}
{% set var_data_dir_task = params.pod.local_data_dir_inside
  | default(params.pod.data_dir, true)
%}

{% set var_orchestration_main_file = 'docker-compose.' + var_pod_type + '.' +
  (var_local | ternary('dev.yml', 'yml'))
%}
{% set var_orchestration_run_file = 'docker-compose.run.' +
  (var_local | ternary('dev.yml', 'yml'))
%}

### main ###

volumes:

- when: false

{% if var_pod_type in ['app', 'db'] %}

- path: "{{ var_data_dir_task + '/mysql' }}"
  mode: "0755"

{% endif %}

{% if var_pod_type in ['app', 'web'] %}

- path: "{{ var_data_dir_task + '/mediawiki/images' }}"
  mode: "0777"

{% endif %}

{% if not var_local %}

- path: "{{ var_data_dir_task + '/log/fluentd' }}"
  mode: "0777"

{% endif %}

templates:

- src: "{{ var_main_dir }}/templates/docker-compose.env"
  dest: "{{ var_main_dir }}/.env"
  root: true
  params:
    ctx_name: "{{ params.env_name }}-{{ params.ctx_name }}-{{ params.pod.name }}"
    data_dir: "{{ var_data_dir }}"
    local: "{{ var_local | default(false) | bool | ternary('true', 'false') }}"
    type: "{{ var_pod_type }}"

    {% if var_pod_type in ['app', 'web'] %}

    nginx_image: "{{ params.main.custom_images.nginx_image }}"
    nginx_version: "{{ params.main.custom_images.nginx_version }}"
    mediawiki_image: "{{ params.main.custom_images.mediawiki_image }}"
    mediawiki_version: "{{ params.main.custom_images.mediawiki_version }}"
    pma_image: "{{ params.main.custom_images.pma_image }}"
    pma_version: "{{ params.main.custom_images.pma_version }}"

    {% endif %}

    {% if var_pod_type in ['app', 'db'] %}

    mysql_image: "{{ params.main.custom_images.mysql_image }}"
    mysql_version: "{{ params.main.custom_images.mysql_version }}"

    {% endif %}

    toolbox_image: "{{ params.main.custom_images.toolbox_image }}"
    toolbox_version: "{{ params.main.custom_images.toolbox_version }}"
    awscli_image: "{{ params.main.custom_images.awscli_image }}"
    awscli_version: "{{ params.main.custom_images.awscli_version }}"

    {% if var_pod_type in ['app', 'web'] %}

    ssl: "{{ params.main.custom_domain.ssl }}"
    main_domain: "{{ params.main.custom_domain.main_domain }}"
    main_domain_port: "{{ params.main.custom_domain.main_port }}"
    pma_domain: "{{ params.main.custom_domain.pma_domain }}"
    pma_domain_port: "{{ params.main.custom_domain.pma_port }}"
    nginx_http_port: "{{ params.main.custom_args.nginx.http_port }}"
    nginx_https_port: "{{ params.main.custom_args.nginx.https_port }}"
    nginx_private_http_port: "{{ params.main.custom_args.nginx.private_http_port }}"
    nginx_private_https_port: "{{ params.main.custom_args.nginx.private_https_port }}"
    pma_login_cookie_validity: >-
      {{ params.main.custom_args.pma.login_cookie_validity | default('36000') }}

    {% endif %}

    db_host: "{{ params.main.custom_args.mysql.host }}"
    db_port: "{{ params.main.custom_args.mysql.port }}"
    db_name: "{{ params.credentials.mediawiki.db.name }}"
    db_user: "{{ params.credentials.mediawiki.db.user }}"
    db_password: "{{ params.credentials.mediawiki.db.password }}"

    {% if var_pod_type in ['app', 'db'] %}

    db_root_password: "{{ params.credentials.mediawiki.db.root_password }}"

    {% endif %}

    s3_backup_access_key: "{{ params.credentials.mediawiki_backup_bucket.access_key }}"
    s3_backup_secret_key: "{{ params.credentials.mediawiki_backup_bucket.secret_key }}"

    {% if var_pod_type in ['app', 'web'] %}

    container_mem_nginx: "{{ params.main.custom_memory.nginx }}"
    container_mem_mediawiki: "{{ params.main.custom_memory.mediawiki }}"
    container_mem_pma: "{{ params.main.custom_memory.pma }}"

    {% endif %}

    {% if var_pod_type in ['app', 'db'] %}

    container_mem_mysql: "{{ params.main.custom_memory.mysql }}"

    {% endif %}

    container_mem_toolbox: "{{ params.main.custom_memory.toolbox }}"
    container_mem_s3_backup: "{{ params.main.custom_memory.s3_backup }}"

    {% if var_local %}

    db_host_ip: ""

    {% else %}

    {% if var_pod_type in ['web'] %}

    db_host_ip: "{{ params.dependencies_node_ip_dict['mysql'] }}"

    {% else %}

    db_host_ip: ""

    {% endif %}

    fluentd_image: "{{ params.main.custom_images.fluentd_image }}"
    fluentd_version: "{{ params.main.custom_images.fluentd_version }}"
    fluentd_port: "{{ params.main.custom_args.fluentd.port }}"
    container_mem_fluentd: "{{ params.main.custom_memory.fluentd }}"

    {% set var_fluentd_output_plugin = params.main.custom_args.fluentd.output_plugin
      | default(
        (var_pod_type in ['app']) | ternary('file', 'elasticsearch')
      )
    %}

    fluentd_output_plugin: "{{ var_fluentd_output_plugin }}"

    {% if var_fluentd_output_plugin == 'elasticsearch' %}

    elasticsearch_host_ip: "{{ params.dependencies_node_ip_dict['elasticsearch'] }}"

    {% endif %}

    {% endif %}

{% set var_server = (params.main.custom_domain.ssl | bool) |
  ternary('https', 'http') + '://' +
  params.main.custom_domain.main_domain
  + (not (params.main.custom_domain.main_port in ['80', '443'])) |
  ternary(':' + params.main.custom_domain.main_port, '')
%}

- src: "{{ var_main_dir }}/templates/mediawiki/LocalSettings.php"
  dest: "{{ var_main_dir }}/env/mediawiki/LocalSettings.php"
  mode: "666"
  root: true
  params:
    sitename: "{{ params.main.mediawiki.sitename }}"
    meta_namespace: "{{ params.main.mediawiki.meta_namespace }}"
    server: "{{ var_server }}"
    logo: "{{ params.main.mediawiki.logo }}"
    emergency_contact: "{{ params.main.mediawiki.emergency_contact }}"
    password_sender: "{{ params.main.mediawiki.password_sender }}"
    db_server: "mysql"
    db_name: "{{ params.credentials.mediawiki.db.name }}"
    db_user: "{{ params.credentials.mediawiki.db.user }}"
    db_password: "{{ params.credentials.mediawiki.db.password }}"
    lang: "{{ params.main.mediawiki.lang }}"
    secret_key: "{{ params.credentials.mediawiki.secret_key }}"
    authentication_token_version: "{{ params.main.mediawiki.authentication_token_version }}"

children:

- name: "main/scripts/vars.run.yml"
  params:
    env_params: {{ params | to_json }}
    pod_custom_dir: "{{ var_main_dir }}"
    run: {{ var_run | to_json }}
    run_dict: {{ var_run_dict | to_json }}
    run_custom:
      var_pod_type: "{{ var_pod_type }}"
      var_orchestration_main_file: "{{ var_orchestration_main_file }}"
      var_orchestration_run_file: "{{ var_orchestration_run_file }}"
