
worker_processes {{ params.worker_process | default('1', true) }};

events {
  worker_connections {{ params.worker_connections | default('512', true) }};
}

http {
  {% macro include_ssl(arg_domain, arg_ssl) %}

    {% if arg_ssl | bool %}

    ssl_certificate       /etc/ssl/live/{{ arg_domain }}/fullchain.pem;
    ssl_certificate_key   /etc/ssl/live/{{ arg_domain }}/privkey.pem;
    include               include/options-ssl-nginx.conf;
    ssl_dhparam           include/ssl-dhparams.pem;

    {% endif %}

  {% endmacro %}

  {% macro include_server_info(arg_domain, arg_listen, arg_ssl, arg_private) %}

    server_name {{ arg_domain }};
    listen {{ arg_listen }};
		server_tokens off;

    {% if arg_private | bool %}

    auth_basic           "Administratorâ€™s Area";
    auth_basic_user_file conf/.htpasswd;

    {% endif %}

    {{ include_ssl(arg_domain, arg_ssl) }}

    {% if arg_listen == '80' %}

		location /.well-known/acme-challenge/ {
			root /var/www/certbot;
		}

    {% endif %}

  {% endmacro %}

  {% macro include_redirect(arg_domain, arg_port, arg_ssl) %}

    {% set var_protocol = arg_ssl | bool | ternary('https', 'http') %}
    {% set var_port_suffix = (arg_port in ('80', '443')) | ternary('', ':' + arg_port) %}

		location / {
      return 301 {{ var_protocol }}://{{ arg_domain }}{{ var_port_suffix }}$request_uri;
		}

  {% endmacro %}

  {% macro include_location_info(arg_upstream, arg_port) %}

      {% set var_port_suffix = (arg_port in ('80', '443')) | ternary('', ':' + arg_port) %}

      proxy_pass         {{ arg_upstream }};
      proxy_redirect     off;
      proxy_set_header   Host                $host{{ var_port_suffix }};
      proxy_set_header   X-Real-IP           $remote_addr;
      proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Host    $server_name;
      proxy_set_header   X-Forwarded-Proto   $scheme;
      proxy_set_header   X-Forwarded-Port    {{ arg_port }};

  {% endmacro %}

  {% set var_default_log_format = '$remote_addr $sent_http_x_user_id $upstream_response_time $status $remote_user [$time_local] "$host" "$request" $body_bytes_sent "$http_referer" "$http_user_agent" $request_time' %}

  log_format main '{{ params.log_format | default(var_default_log_format, true) }}';
  access_log /dev/stdout main;
  error_log /dev/stderr;

  limit_req_zone $binary_remote_addr zone=mainlimit:10m rate={{ params.limit_req_zone_rate | default('3r/s', true) }};
  limit_conn_zone $binary_remote_addr zone=connlimit:10m;
  limit_conn_zone $binary_remote_addr zone=uploadconnlimit:10m;

  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=web_cache:{{ params.web_cache | default('20m', true) }} max_size={{ params.web_cache_max_size | default('200m', true) }} inactive={{ params.web_cache_inactive | default('30m', true) }};
  proxy_connect_timeout  {{ params.proxy_connect_timeout | default('30', true) }};
  proxy_send_timeout     {{ params.proxy_send_timeout | default('60', true) }};
  proxy_read_timeout     {{ params.proxy_read_timeout | default('60', true) }};

  send_timeout           {{ params.send_timeout | default('60', true) }};
  client_body_timeout    {{ params.client_body_timeout | default('5s', true) }};
  client_header_timeout  {{ params.client_header_timeout | default('5s', true) }};

	include include/gzip.conf;

  {% set var_kibana_service = 'kibana:5601' %}
  {% set var_kibana_upstream = 'upstream-kibana' %}
  {% set var_kibana_upstream_full = 'http://' + var_kibana_upstream %}
  {% set var_kibana_listen = params.kibana_ssl | bool | ternary('9443 ssl', '9080') %}
  {% set var_kibana_private = true %}

  upstream {{ var_kibana_upstream }} {
    server {{ var_kibana_service }};
  }

  server {
    {{ include_server_info(params.kibana_domain, 80, false, var_kibana_private) }}
  }

  {% if params.kibana_ssl | bool %}

  server {
    {{ include_server_info(params.kibana_domain, 9080, false, var_kibana_private) }}
    {{ include_redirect(params.kibana_domain, params.kibana_port, params.kibana_ssl) }}
  }

  {% endif %}

  server {
    {{ include_server_info(params.kibana_domain, var_kibana_listen, params.kibana_ssl, var_kibana_private) }}

    location / {
      {{ include_location_info(var_kibana_upstream_full, params.kibana_port) }}
    }
  }
}