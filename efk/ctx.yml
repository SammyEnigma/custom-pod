## general vars - start ###

{% set var_local = params.main.local | default(false) | bool %}
{% set var_run = params.main.run | default({}) %}
{% set var_run_tasks = params.main.run_tasks | default({}) %}
{% set var_run_dict = params.main.run_dict | default({}) %}
{% set var_run_tasks_dict = params.main.run_tasks_dict | default({}) %}

## general vars - end ###

### others ###

{% set var_pod_type = params.main.type | default('') %}

{% if not (var_pod_type in ['app']) %}
  {% set error = {} %}
  {{ error['error.pod_type.invalid.' + var_pod_type] }}
{% endif %}

{% set var_main_dir = params.main.custom_dir + '/efk' %}

{% set var_pod_dir_rel = '../..' %}
{% set var_data_dir = var_local
  | ternary(var_pod_dir_rel + '/' + params.pod.data_dir, params.pod.data_dir) %}
{% set var_data_dir_task = params.pod.local_data_dir_inside
  | default(params.pod.data_dir, true)
%}

{% set var_kibana_domain_port = params.main.custom_domain.kibana_ssl | bool |
  ternary(params.main.custom_domain.private_https_port, params.main.custom_domain.private_http_port)
%}

{% if params.main.use_theia | bool %}
  {% set var_theia_domain_port = params.main.custom_domain.theia_ssl | bool |
    ternary(params.main.custom_domain.private_https_port, params.main.custom_domain.private_http_port)
  %}
{% endif %}

{% if params.main.use_fluentd %}

  {% set var_fluentd_output_plugin = params.main.custom_args.fluentd.output_plugin
    | default(
      (var_pod_type in ['app', 'db']) | ternary('file', 'elasticsearch')
    )
  %}

{% endif %}

### main ###

env_files:

- when: false

{% if var_pod_type in ['app', 'web'] %}

- src: "{{ params.main.auth_file }}"
  dest: "{{ var_main_dir }}/env/nginx/conf/.htpasswd"
  root: true

{% endif %}

templates:

{% set var_ctx_full_name = params.env_name  + '-' + params.ctx_name + '-' + params.pod.name %}
{% set var_ctx_prefix_main = params.main.use_prefix | bool
  | ternary(var_ctx_full_name + '-main', '')
%}
{% set var_ctx_prefix_run = params.main.use_prefix | bool
  | ternary(var_ctx_full_name + '-run', '')
%}

- src: "{{ var_main_dir }}/templates/docker-compose.tpl.yml"
  dest: "{{ var_main_dir }}/docker-compose.yml"
  root: true
  params:
    local: "{{ var_local | default(false) | bool | ternary('true', 'false') }}"
    pod_type: "{{ var_pod_type }}"
    use_fluentd: "{{ params.main.use_fluentd }}"
    internal_elasticsearch: "{{ params.main.internal_elasticsearch | default('false') }}"
    external_volumes: "{{ params.main.external_volumes | default('false') }}"
    images: {{ params.main.custom_images | to_json }}
    memory: {{ params.main.custom_memory | to_json }}

    {% if var_pod_type in ['app', 'web'] %}

    use_nginx: "{{ params.main.use_nginx }}"
    use_theia: "{{ params.main.use_theia }}"

    {% endif %}

    {% if params.main.use_fluentd %}

    fluentd_output_plugin: "{{ var_fluentd_output_plugin }}"

    {% endif %}

- src: "{{ var_main_dir }}/templates/docker-compose.tpl.run.yml"
  dest: "{{ var_main_dir }}/docker-compose.run.yml"
  root: true
  params:
    local: "{{ var_local | default(false) | bool | ternary('true', 'false') }}"
    pod_type: "{{ var_pod_type }}"
    use_fluentd: "{{ params.main.use_fluentd }}"
    images: {{ params.main.custom_images | to_json }}
    memory: {{ params.main.custom_memory | to_json }}

    {% if var_pod_type in ['app', 'web'] %}

    use_certbot: "{{ params.main.use_certbot }}"

    {% endif %}

- src: "{{ var_main_dir }}/templates/docker-compose.env"
  dest: "{{ var_main_dir }}/.env"
  root: true
  params:
    ctx_full_name: "{{ var_ctx_full_name }}"
    ctx_prefix_main: "{{ var_ctx_prefix_main }}"
    ctx_prefix_run: "{{ var_ctx_prefix_run }}"
    data_dir: "{{ var_data_dir }}"
    local: "{{ var_local | default(false) | bool | ternary('true', 'false') }}"
    type: "{{ var_pod_type }}"
    use_fluentd: "{{ params.main.use_fluentd }}"

    {% if var_pod_type in ['app', 'web'] %}

    use_nginx: "{{ params.main.use_nginx }}"

    {% if params.main.use_nginx | bool %}

    public_http_port: "{{ params.main.custom_domain.public_http_port }}"
    public_https_port: "{{ params.main.custom_domain.public_https_port }}"
    private_http_port: "{{ params.main.custom_domain.private_http_port }}"
    private_https_port: "{{ params.main.custom_domain.private_https_port }}"

    {% else %}

    kibana_port: "{{ params.main.custom_args.kibana.port }}"

    {% endif %}

    {% endif %}

    {% if var_pod_type in ['app', 'db'] %}

    elasticsearch_java_opts: "{{ params.main.custom_args.elasticsearch.java_opts }}"
    internal_elasticsearch: "{{ params.main.internal_elasticsearch | default('false') }}"

    {% if not (params.main.internal_elasticsearch | default('false') | bool) %}

    elasticsearch_port: "{{ params.main.custom_args.elasticsearch.port }}"

    {% endif %}

    {% endif %}

    s3_backup_access_key: "{{ params.credentials.efk_backup_bucket.access_key }}"
    s3_backup_secret_key: "{{ params.credentials.efk_backup_bucket.secret_key }}"

    {% if var_pod_type in ['app', 'web'] %}

    use_certbot: "{{ params.main.use_certbot }}"

    {% endif %}

    {% if params.main.use_fluentd %}

    fluentd_port: "{{ params.main.custom_args.fluentd.port }}"

    {% endif %}

    {% if params.main.type == 'web' %}

    db_host_ip: "{{ var_elasticsearch_host_ip }}"

    {% endif %}

{% if var_pod_type in ['app', 'web'] %}

{% if not params.main.custom_args.nginx.custom | default(false) | bool %}

- src: "{{ var_main_dir }}/templates/nginx/nginx.conf"
  dest: "{{ var_main_dir }}/env/nginx/nginx.conf"
  root: true
  params:
    conf: {{ params.main.custom_args.nginx.conf | default({}) | to_json }}
    main_domain: "{{ params.main.custom_domain.main_domain }}"
    kibana_domain: "{{ params.main.custom_domain.kibana_domain }}"
    kibana_port: "{{ var_kibana_domain_port }}"
    kibana_ssl: "{{ params.main.custom_domain.kibana_ssl }}"
    use_theia: "{{ params.main.use_theia }}"

    {% if params.main.use_theia | bool %}

    theia_domain: "{{ params.main.custom_domain.theia_domain }}"
    theia_port: "{{ var_theia_domain_port }}"
    theia_ssl: "{{ params.main.custom_domain.theia_ssl }}"

    {% endif %}

{% endif %}

{% endif %}

children:

- name: "main/scripts/vars.run.yml"
  params:
    env_params: {{ params | to_json }}
    pod_custom_dir: "{{ var_main_dir }}"
    run: {{ var_run | to_json }}
    run_tasks: {{ var_run_tasks | to_json }}
    run_dict: {{ var_run_dict | to_json }}
    run_tasks_dict: {{ var_run_tasks_dict | to_json }}
    run_custom:
      var_custom__pod_type: "{{ var_pod_type }}"
      var_custom__local: "{{ var_local | bool | ternary('true', 'false') }}"
      var_custom__use_fluentd: "{{ params.main.use_fluentd | bool | ternary('true', 'false') }}"

      {% if var_pod_type in ['app', 'web'] %}

      var_custom__use_certbot: "{{ params.main.use_certbot | bool | ternary('true', 'false') }}"

      {% endif %}
