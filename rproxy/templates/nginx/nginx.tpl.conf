{% set var_global_main_domain = params.main_domain | default([]) %}
{% set var_global_conf = params.conf | default({}) %}
{% set var_global_services = params.services | default([]) %}

{% set var_global_ssl = var_global_conf.ssl | default(false) %}

{################################################################################################}
{% macro include_ssl() %}

    ssl_certificate       /etc/ssl/live/{{ var_global_main_domain }}/fullchain.pem;
    ssl_certificate_key   /etc/ssl/live/{{ var_global_main_domain }}/privkey.pem;
    include               include/options-ssl-nginx.conf;
    ssl_dhparam           include/ssl-dhparams.pem;

{% endmacro %}
{################################################################################################}

{################################################################################################}
{% macro include_cache(args) %}

      {% set var_proxy_cache_valid = args.proxy_cache_valid
        | default(var_global_conf.proxy_cache_valid | default('1h'))
      %}
      {% set var_expires = args.expires
        | default(var_global_conf.expires | default('1h'))
      %}

      proxy_cache                web_cache;
      proxy_cache_valid          200 301 302 {{ var_proxy_cache_valid }};
      expires                    {{ var_expires }};
      add_header Cache-Control   "public";
      add_header X-Asset         "yes";

{% endmacro %}
{################################################################################################}

{################################################################################################}
{% macro include_allow_origin(args) %}

    {% set var_arg_custom_headers = args.custom_headers | default([]) %}

    {% set var_default_methods = [
        'GET', 'POST', 'OPTIONS', 'PUT', 'DELETE'
      ]
    %}
    {% set var_methods = args.custom_headers | default(var_default_methods) %}

    {% set var_allowed_headers_fixed = [
        'DNT',
        'X-CustomHeader',
        'Keep-Alive',
        'User-Agent',
        'X-Requested-With',
        'If-Modified-Since',
        'Cache-Control',
        'Content-Type'
      ]
    %}
    {% set var_allowed_headers = (var_arg_custom_headers + var_allowed_headers_fixed) | unique %}

    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    add_header 'Access-Control-Allow-Methods' '{{ var_methods | join(",") }}' always;
    add_header 'Access-Control-Allow-Headers' '{{ var_allowed_headers | join(",") }}' always;

{% endmacro %}
{################################################################################################}

{################################################################################################}
{% macro include_server_info(args) %}

    {% set var_arg_domain = args.domain | default('') %}
    {% set var_arg_port = args.port | default('') %}
    {% set var_arg_ssl = args.ssl | default(false) %}
    {% set var_arg_private = args.private | default(false) %}
    {% set var_arg_use_basic_auth = args.use_basic_auth | default(false) %}
    {% set var_arg_validate_origin = args.validate_origin | default(false) %}

    {% set var_listen =
      var_arg_private | bool
      | ternary(
        var_arg_ssl | bool | ternary('9443 ssl', '9080'),
        var_arg_ssl | bool | ternary('443 ssl', '80')
      )
    %}

    server_name {{ var_arg_domain }};
    listen {{ var_listen }};
		server_tokens off;

    {################################################################################################}
    {% if var_arg_use_basic_auth | bool %}

    auth_basic           "Administratorâ€™s Area";
    auth_basic_user_file conf/.htpasswd;

    {% endif %}
    {################################################################################################}

    {################################################################################################}
    {% if not (var_arg_private | bool) %}

    if ( $ip_blacklist = 1 ) {
        return 403;
    }
    if ( $ua_blacklist = 1 ) {
        return 403;
    }

    {% endif %}
    {################################################################################################}

    {################################################################################################}
    {% if (var_global_conf.enable_validate_origin | bool) and (var_arg_validate_origin | bool) %}

    {% set var_protocol = var_arg_ssl | bool | ternary('https', 'http') %}
    {% set var_port_suffix = (var_arg_port in ('80', '443')) | ternary('', ':' + var_arg_port) %}

    set $my_origin "{{ var_protocol }}://{{ var_arg_domain }}{{ var_port_suffix }}";
    include include/validate-origin.conf;

    {% endif %}
    {################################################################################################}

    {################################################################################################}
    {% if var_arg_ssl | bool %}

    {{ include_ssl() }}

    {% endif %}
    {################################################################################################}

    {################################################################################################}
    {% if (var_listen | string) == '80' %}

		location /.well-known/acme-challenge/ {
			root /var/www/certbot;
		}

    {% endif %}
    {################################################################################################}

{% endmacro %}
{################################################################################################}

{################################################################################################}
{% macro include_redirect(args) %}

    {% set var_arg_domain = args.domain | default('') %}
    {% set var_arg_port = args.port | default('') %}
    {% set var_arg_ssl = args.ssl | default(false) %}

    {% set var_protocol = var_arg_ssl | bool | ternary('https', 'http') %}
    {% set var_port_suffix = (var_arg_port in ('80', '443')) | ternary('', ':' + var_arg_port) %}

		location / {
      return 301 {{ var_protocol }}://{{ var_arg_domain }}{{ var_port_suffix }}$request_uri;
		}

{% endmacro %}
{################################################################################################}

{################################################################################################}
{% macro include_proxy_location_info(args) %}

      {% set var_arg_service = args.service | default('') %}
      {% set var_arg_port = args.port | default('') %}
      {% set var_arg_upgrade = args.upgrade | default(false) %}
      {% set var_arg_use_basic_auth = args.use_basic_auth | default(false) %}

      {% set var_port_suffix = (var_arg_port in ('80', '443')) | ternary('', ':' + var_arg_port) %}

      resolver {{ var_global_conf.resolver | default('127.0.0.11', true) }}{{ ''
      }} valid={{ var_global_conf.resolver_time | default('30s', true) }};

      set $var_proxy     {{ var_arg_service }};
      proxy_pass         $var_proxy;
      proxy_redirect     off;
      proxy_set_header   Host                $host{{ var_port_suffix }};
      proxy_set_header   X-Real-IP           $remote_addr;
      proxy_set_header   X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header   X-Forwarded-Host    $server_name;
      proxy_set_header   X-Forwarded-Proto   $scheme;
      proxy_set_header   X-Forwarded-Port    {{ var_arg_port }};

      {% if var_arg_upgrade | bool %}

      proxy_set_header   Upgrade             $http_upgrade;
      proxy_set_header   Connection          $connection_upgrade;

      {% endif %}

      {% if var_arg_use_basic_auth | bool %}

      proxy_set_header   Authorization       "";

      {% endif %}

{% endmacro %}
{################################################################################################}

{################################################################################################}
{% macro include_service(args) %}

  {% set var_arg_name = args.name | default('') %}
  {% set var_arg_domain = args.domain | default('') %}
  {% set var_arg_service = args.service | default('') %}
  {% set var_arg_port = args.port | default('') %}
  {% set var_arg_ssl = args.ssl | default(false) %}
  {% set var_arg_upgrade = args.upgrade | default(false) %}
  {% set var_arg_private = args.private | default(false) %}
  {% set var_arg_use_basic_auth = args.use_basic_auth | default(false) %}

  {% set var_listen =
    var_arg_private | bool
    | ternary(
      var_arg_ssl | bool | ternary('9443 ssl', '9080'),
      var_arg_ssl | bool | ternary('443 ssl', '80')
    )
  %}

  {% set var_locations_info = args.locations_info | default([{ 'locations': ['/'] }]) %}

  {% set var_http_port = var_arg_private | bool | ternary('9080', '80') %}

  ### [service - start] {{ var_arg_name }} ###

  {################################################################################################}
  {% if var_arg_private | bool %}
  ### Listen on port 80 to generate SSL certificates ###

  server {
    {{ include_server_info({
        'arg_domain': var_arg_domain,
        'arg_listen': 80,
        'arg_port': var_arg_port,
        'arg_ssl': false,
        'arg_private': var_arg_private,
        'arg_use_basic_auth': false,
        'arg_validate_origin': false
      })
    }}
  }

  {% endif %}
  {################################################################################################}

  {################################################################################################}
  {% if var_arg_domain == var_global_main_domain %}
  ### Redirect ###
  ### From: www.{{ var_arg_domain }}:{{ var_http_port }} ###
  ### To: {{ var_arg_domain }}:{{ var_arg_port }} ###

  server {
    {{ include_server_info({
        'arg_domain': 'www.' + var_arg_domain,
        'arg_listen': var_http_port,
        'arg_port': var_arg_port,
        'arg_ssl': false,
        'arg_private': var_arg_private,
        'arg_use_basic_auth': false,
        'arg_validate_origin': false
      })
    }}
    {{ include_redirect(args) }}
  }

  {% endif %}
  {################################################################################################}

  {################################################################################################}
  {% if var_arg_ssl | bool %}
  ### Redirect ###
  ### From: {{ var_arg_domain }}:{{ var_http_port }} ###
  ### To: {{ var_arg_domain }}:{{ var_arg_port }} ###

  server {
    {{ include_server_info({
        'arg_domain': var_arg_domain,
        'arg_listen': var_http_port,
        'arg_port': var_arg_port,
        'arg_ssl': false,
        'arg_private': var_arg_private,
        'arg_use_basic_auth': false,
        'arg_validate_origin': false
      })
    }}
    {{ include_redirect(args) }}
  }

  {% endif %}
  {################################################################################################}

  {################################################################################################}
  {% if (var_arg_ssl | bool) and (var_arg_domain == var_global_main_domain) %}
  ### Redirect ###
  ### From: www.{{ var_arg_domain }}:{{ var_listen }} ###
  ### To: {{ var_arg_domain }}:{{ var_arg_port }} ###

  server {
    {{ include_server_info(
        'www.' + var_arg_domain,
        var_listen,
        var_arg_port,
        var_arg_ssl,
        var_arg_private,
        false,
        false
      )
    }}
    {{ include_redirect(args) }}
  }

  {% endif %}
  {################################################################################################}

  ### Main Server Configuration for {{ var_arg_domain }} ###

  server {
    {{ include_server_info(
        var_arg_domain,
        var_listen,
        var_arg_port,
        var_arg_ssl,
        var_arg_private,
        var_arg_use_basic_auth,
        true
      )
    }}

    {################################################################################################}
    {% for location_info in var_locations_info %}

    {################################################################################################}
    {% for location in location_info.locations | default([]) %}

    location {{ location }} {

      {################################################################################################}
      {% if location_info.include_cache | default(false) | bool %}

      {{ include_cache(location_info.cache_args | default({})) }}

      {% endif %}
      {################################################################################################}

      {################################################################################################}
      {% if location_info.allow_origin | default(false) | bool %}

      {{ include_allow_origin(location_info.allow_origin_args | default({})) }}

      {% endif %}
      {################################################################################################}

      {################################################################################################}
      {% if (location_info.data | default('')) == '' %}

      {{ include_proxy_location_info(args) }}

      {% else %}

      {################################################################################################}
      {% for line in location_info.data | split('\n') %}

      {{ line }}

      {% endfor %}
      {################################################################################################}

      {% endif %}
      {################################################################################################}

    }

    {% endfor %}
    {################################################################################################}

    {% endfor %}
    {################################################################################################}

  }

  ### [service - end] {{ var_arg_name }} ###

{% endmacro %}
{################################################################################################}

worker_processes {{ var_global_conf.worker_process | default('1', true) }};

events {
  worker_connections {{ var_global_conf.worker_connections | default('512', true) }};
}

http {
  {% set var_default_log_format =
    '$remote_addr'
    + ' $sent_http_x_user_id'
    + ' $upstream_response_time'
    + ' $status'
    + ' $remote_user'
    + ' [$time_local]'
    + ' "$host"'
    + ' "$request"'
    + ' $body_bytes_sent'
    + ' "$http_referer"'
    + ' "$http_user_agent"'
    + ' $request_time'
  %}

  log_format main '{{ var_global_conf.log_format | default(var_default_log_format, true) }}';
  access_log /dev/stdout main;
  error_log /dev/stderr;

  limit_req_zone $binary_remote_addr zone=mainlimit:10m rate={{ var_global_conf.limit_req_zone_rate | default('3r/s', true) }};
  limit_req_zone $binary_remote_addr zone=bglimit:10m rate={{ var_global_conf.bg_limit_req_zone_rate | default('3r/s', true) }};
  limit_conn_zone $binary_remote_addr zone=connlimit:10m;
  limit_conn_zone $binary_remote_addr zone=bgconnlimit:10m;
  limit_conn_zone $binary_remote_addr zone=uploadconnlimit:10m;

  proxy_cache_path /var/cache/nginx levels=1:2{{ ''
  }} keys_zone=web_cache:{{ var_global_conf.web_cache_size | default('20m', true) }}{{ ''
  }} max_size={{ var_global_conf.web_cache_max_size | default('200m', true) }}{{ ''
  }} inactive={{ var_global_conf.web_cache_inactive | default('30m', true) }};
  proxy_connect_timeout  {{ var_global_conf.proxy_connect_timeout | default('30', true) }};
  proxy_send_timeout     {{ var_global_conf.proxy_send_timeout | default('60', true) }};
  proxy_read_timeout     {{ var_global_conf.proxy_read_timeout | default('60', true) }};

  send_timeout           {{ var_global_conf.send_timeout | default('60', true) }};
  client_body_timeout    {{ var_global_conf.client_body_timeout | default('5s', true) }};
  client_header_timeout  {{ var_global_conf.client_header_timeout | default('5s', true) }};

	include include/gzip.conf;

	map_hash_max_size {{ var_global_conf.map_hash_max_size | default('1024', true) }};
	map_hash_bucket_size {{ var_global_conf.map_hash_bucket_size | default('128', true) }};

	geo $ip_blacklist {
		include /var/main/data/sync/nginx/manual/ips-blacklist.conf;
		include /var/main/data/sync/nginx/auto/ips-blacklist-auto.conf;
		default 0;
	}

	map $http_user_agent $ua_blacklist {
		include /var/main/data/sync/nginx/manual/ua-blacklist.conf;
		default 0;
	}

  map $http_upgrade $connection_upgrade {
      default upgrade;
      '' close;
  }

  server {
    listen 80 default_server;
    listen 8080 default_server;
    listen 9080 default_server;
    return 444;
  }

  {################################################################################################}
  {% if var_global_ssl | bool %}

  server {
    listen 443 default_server ssl;
    listen 8443 default_server ssl;
    listen 9443 default_server ssl;

    {{ include_ssl() }}

    return 444;
  }

  {% endif %}
  {################################################################################################}

  {################################################################################################}
  {% for service in var_global_services | default([]) %}

  {################################################################################################}
  {% if service.when | default(true) | bool %}

  {{ include_service(service) }}

  {% endif %}
  {################################################################################################}

  {% endfor %}
  {################################################################################################}

}